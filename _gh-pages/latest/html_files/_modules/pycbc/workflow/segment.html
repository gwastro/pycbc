<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pycbc.workflow.segment &mdash; PyCBC 0.0a8230 documentation</title><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/terminal.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../_static/typed.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> PyCBC
          </a>
              <div class="version">
                1.18.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../credit.html">Use of PyCBC in Scientific Publications</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docker.html">Running PyCBC under Docker</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installing PyCBC</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../inference.html">PyCBC inference documentation (<code class="docutils literal notranslate"><span class="pre">pycbc.inference</span></code>)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflow/pycbc_make_psd_estimation_workflow.html"><code class="docutils literal notranslate"><span class="pre">pycbc_make_psd_estimation_workflow</span></code>: A workflow generator for noise estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflow/pycbc_make_coinc_search_workflow.html"><code class="docutils literal notranslate"><span class="pre">pycbc_make_coinc_search_workflow</span></code>: A workflow to search for gravitational waves</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflow/pygrb.html"><code class="docutils literal notranslate"><span class="pre">pycbc_make_offline_grb_workflow</span></code>: A GRB triggered CBC analysis workflow generator</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tmpltbank.html">PyCBC template bank generation documentation (<code class="docutils literal notranslate"><span class="pre">pycbc.tmpltbank</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hwinj.html">Hardware injection waveform generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../banksim.html">Calculating the Effectualness (Fitting Factor) of Template Banks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faithsim.html">Dag Generator for Doing Faithfulness Comparisons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../upload_to_gracedb.html">Uploading triggers to gracedb</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../waveform_plugin.html">Making new waveform approximants available to PyCBC</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../catalog.html">Catalog of Observed Gravitational-wave Mergers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataquality.html">Query times of valid data, hardware injections, and more.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../frame.html">Reading Gravitational-wave Frames</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fft.html">Performing FFTs in PyCBC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gw150914.html">Signal Processing with GW150914</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../detector.html">Gravitational-wave Detectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../psd.html">Handling PSDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../noise.html">Generating Noise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../waveform.html">Waveforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../filter.html">Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributions.html">Using PyCBC Distributions from PyCBC Inference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../building_bundled_executables.html">Building Bundled Executables</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">Documenting PyCBC code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release.html">Creating Releases of PyCBC</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../formats/hdf_format.html">HDF files within the PyCBC workflow</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflow.html">Workflow: the inspiral analysis workflow generator (<code class="docutils literal notranslate"><span class="pre">pycbc.workflow</span></code>)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">pycbc</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyCBC</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
          <li><a href="../../pycbc.html">pycbc</a> &raquo;</li>
      <li>pycbc.workflow.segment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pycbc.workflow.segment</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (C) 2013  Ian Harry</span>
<span class="c1">#</span>
<span class="c1"># This program is free software; you can redistribute it and/or modify it</span>
<span class="c1"># under the terms of the GNU General Public License as published by the</span>
<span class="c1"># Free Software Foundation; either version 3 of the License, or (at your</span>
<span class="c1"># option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful, but</span>
<span class="c1"># WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General</span>
<span class="c1"># Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License along</span>
<span class="c1"># with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="c1"># 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>

<span class="c1">#</span>
<span class="c1"># =============================================================================</span>
<span class="c1">#</span>
<span class="c1">#                                   Preamble</span>
<span class="c1">#</span>
<span class="c1"># =============================================================================</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module is responsible for setting up the segment generation stage of</span>
<span class="sd">workflows. For details about this module and its capabilities see here:</span>
<span class="sd">https://ldas-jobs.ligo.caltech.edu/~cbc/docs/pycbc/ahope/segments.html</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">stat</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">six.moves.urllib.request</span> <span class="kn">import</span> <span class="n">pathname2url</span>
<span class="kn">from</span> <span class="nn">six.moves.urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span><span class="p">,</span> <span class="n">urlunparse</span>
<span class="kn">import</span> <span class="nn">lal</span>
<span class="kn">from</span> <span class="nn">ligo</span> <span class="kn">import</span> <span class="n">segments</span>
<span class="kn">from</span> <span class="nn">ligo.segments</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">segmentsUtils</span>
<span class="kn">from</span> <span class="nn">glue.ligolw</span> <span class="kn">import</span> <span class="n">table</span><span class="p">,</span> <span class="n">lsctables</span><span class="p">,</span> <span class="n">ligolw</span>
<span class="kn">from</span> <span class="nn">pycbc.workflow.core</span> <span class="kn">import</span> <span class="n">Executable</span><span class="p">,</span> <span class="n">FileList</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">SegFile</span><span class="p">,</span> <span class="n">make_analysis_dir</span><span class="p">,</span> <span class="n">make_external_call</span><span class="p">,</span> <span class="n">File</span>
<span class="kn">from</span> <span class="nn">pycbc.workflow.core</span> <span class="kn">import</span> <span class="n">resolve_url</span>
<span class="kn">from</span> <span class="nn">pycbc.workflow.jobsetup</span> <span class="kn">import</span> <span class="n">LigolwAddExecutable</span><span class="p">,</span> <span class="n">LigoLWCombineSegsExecutable</span>

<div class="viewcode-block" id="get_science_segments"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.get_science_segments">[docs]</a><span class="k">def</span> <span class="nf">get_science_segments</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the analyzable segments after applying ini specified vetoes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    workflow : Workflow object</span>
<span class="sd">        Instance of the workflow object</span>
<span class="sd">    out_dir : path</span>
<span class="sd">        Location to store output files</span>
<span class="sd">    tags : list of strings</span>
<span class="sd">        Used to retrieve subsections of the ini file for</span>
<span class="sd">        configuration options.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    sci_seg_file : workflow.core.SegFile instance</span>
<span class="sd">        The segment file combined from all ifos containing the science segments.</span>
<span class="sd">    sci_segs : Ifo keyed dict of ligo.segments.segmentlist instances</span>
<span class="sd">        The science segs for each ifo, keyed by ifo</span>
<span class="sd">    sci_seg_name : str</span>
<span class="sd">        The name with which science segs are stored in the output XML file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting generation of science segments&#39;</span><span class="p">)</span>

    <span class="n">make_analysis_dir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># NOTE: Should this be overrideable in the config file?</span>
    <span class="n">sci_seg_name</span> <span class="o">=</span> <span class="s2">&quot;SCIENCE&quot;</span>
    <span class="n">sci_segs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sci_seg_dict</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>
    <span class="n">sci_seg_summ_dict</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ifos</span><span class="p">:</span>
        <span class="n">curr_sci_segs</span><span class="p">,</span> <span class="n">curr_sci_xml</span><span class="p">,</span> <span class="n">curr_seg_name</span> <span class="o">=</span> <span class="n">get_sci_segs_for_ifo</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span>
                              <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
        <span class="n">sci_seg_dict</span><span class="p">[</span><span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">sci_seg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_sci_segs</span>
        <span class="n">sci_segs</span><span class="p">[</span><span class="n">ifo</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_sci_segs</span>
        <span class="n">sci_seg_summ_dict</span><span class="p">[</span><span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">sci_seg_name</span><span class="p">]</span> <span class="o">=</span> \
                          <span class="n">curr_sci_xml</span><span class="o">.</span><span class="n">seg_summ_dict</span><span class="p">[</span><span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">curr_seg_name</span><span class="p">]</span>
    <span class="n">sci_seg_file</span> <span class="o">=</span> <span class="n">SegFile</span><span class="o">.</span><span class="n">from_segment_list_dict</span><span class="p">(</span><span class="n">sci_seg_name</span><span class="p">,</span>
                                          <span class="n">sci_seg_dict</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">,</span>
                                          <span class="n">valid_segment</span><span class="o">=</span><span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">,</span>
                                          <span class="n">seg_summ_dict</span><span class="o">=</span><span class="n">sci_seg_summ_dict</span><span class="p">,</span>
                                          <span class="n">directory</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done generating science segments&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sci_seg_file</span><span class="p">,</span> <span class="n">sci_segs</span><span class="p">,</span> <span class="n">sci_seg_name</span></div>

<div class="viewcode-block" id="get_files_for_vetoes"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.get_files_for_vetoes">[docs]</a><span class="k">def</span> <span class="nf">get_files_for_vetoes</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                         <span class="n">runtime_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">in_workflow_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the various sets of veto segments that will be used in this analysis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    workflow : Workflow object</span>
<span class="sd">        Instance of the workflow object</span>
<span class="sd">    out_dir : path</span>
<span class="sd">        Location to store output files</span>
<span class="sd">    runtime_names : list</span>
<span class="sd">        Veto category groups with these names in the [workflow-segment] section</span>
<span class="sd">        of the ini file will be generated now.</span>
<span class="sd">    in_workflow_names : list</span>
<span class="sd">        Veto category groups with these names in the [workflow-segment] section</span>
<span class="sd">        of the ini file will be generated in the workflow. If a veto category</span>
<span class="sd">        appears here and in runtime_names, it will be generated now.</span>
<span class="sd">    tags : list of strings</span>
<span class="sd">        Used to retrieve subsections of the ini file for</span>
<span class="sd">        configuration options.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    veto_seg_files : FileList</span>
<span class="sd">        List of veto segment files generated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">runtime_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">runtime_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">in_workflow_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">in_workflow_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting generating veto files for analysis&#39;</span><span class="p">)</span>
    <span class="n">make_analysis_dir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">save_veto_definer</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>

    <span class="n">now_cat_sets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">runtime_names</span><span class="p">:</span>
        <span class="n">cat_sets</span> <span class="o">=</span> <span class="n">parse_cat_ini_opt</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span>
                                              <span class="s1">&#39;workflow-segments&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tags</span><span class="p">))</span>
        <span class="n">now_cat_sets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cat_sets</span><span class="p">)</span>

    <span class="n">now_cats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cset</span> <span class="ow">in</span> <span class="n">now_cat_sets</span><span class="p">:</span>
        <span class="n">now_cats</span> <span class="o">=</span> <span class="n">now_cats</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">cset</span><span class="p">)</span>

    <span class="n">later_cat_sets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">in_workflow_names</span><span class="p">:</span>
        <span class="n">cat_sets</span> <span class="o">=</span> <span class="n">parse_cat_ini_opt</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span>
                                              <span class="s1">&#39;workflow-segments&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tags</span><span class="p">))</span>
        <span class="n">later_cat_sets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cat_sets</span><span class="p">)</span>

    <span class="n">later_cats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cset</span> <span class="ow">in</span> <span class="n">later_cat_sets</span><span class="p">:</span>
        <span class="n">later_cats</span> <span class="o">=</span> <span class="n">later_cats</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">cset</span><span class="p">)</span>
        <span class="c1"># Avoid duplication</span>
        <span class="n">later_cats</span> <span class="o">=</span> <span class="n">later_cats</span> <span class="o">-</span> <span class="n">now_cats</span>

    <span class="n">veto_gen_job</span> <span class="o">=</span> <span class="n">create_segs_from_cats_job</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                                             <span class="n">workflow</span><span class="o">.</span><span class="n">ifo_string</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>

    <span class="n">cat_files</span> <span class="o">=</span> <span class="n">FileList</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ifos</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">now_cats</span><span class="p">:</span>
            <span class="n">cat_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_veto_segs</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span>
                                        <span class="n">cat_to_veto_def_cat</span><span class="p">(</span><span class="n">category</span><span class="p">),</span>
                                        <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                                        <span class="n">veto_gen_job</span><span class="p">,</span> <span class="n">execute_now</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">later_cats</span><span class="p">:</span>
            <span class="n">cat_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_veto_segs</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span>
                                        <span class="n">cat_to_veto_def_cat</span><span class="p">(</span><span class="n">category</span><span class="p">),</span>
                                        <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                                        <span class="n">veto_gen_job</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
                                        <span class="n">execute_now</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done generating veto segments&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cat_files</span></div>

<div class="viewcode-block" id="get_analyzable_segments"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.get_analyzable_segments">[docs]</a><span class="k">def</span> <span class="nf">get_analyzable_segments</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">sci_segs</span><span class="p">,</span> <span class="n">cat_files</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the analyzable segments after applying ini specified vetoes and any</span>
<span class="sd">    other restrictions on the science segs, e.g. a minimum segment length, or</span>
<span class="sd">    demanding that only coincident segments are analysed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    workflow : Workflow object</span>
<span class="sd">        Instance of the workflow object</span>
<span class="sd">    sci_segs : Ifo-keyed dictionary of glue.segmentlists</span>
<span class="sd">        The science segments for each ifo to which the vetoes, or any other</span>
<span class="sd">        restriction, will be applied.</span>
<span class="sd">    cat_files : FileList of SegFiles</span>
<span class="sd">        The category veto files generated by get_veto_segs</span>
<span class="sd">    out_dir : path</span>
<span class="sd">        Location to store output files</span>
<span class="sd">    tags : list of strings</span>
<span class="sd">        Used to retrieve subsections of the ini file for</span>
<span class="sd">        configuration options.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    sci_ok_seg_file : workflow.core.SegFile instance</span>
<span class="sd">        The segment file combined from all ifos containing the analyzable</span>
<span class="sd">        science segments.</span>
<span class="sd">    sci_ok_segs : Ifo keyed dict of ligo.segments.segmentlist instances</span>
<span class="sd">        The analyzable science segs for each ifo, keyed by ifo</span>
<span class="sd">    sci_ok_seg_name : str</span>
<span class="sd">        The name with which analyzable science segs are stored in the output</span>
<span class="sd">        XML file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting reducing to analysable science segments&#39;</span><span class="p">)</span>

    <span class="n">make_analysis_dir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="c1"># NOTE: Should this be overrideable in the config file?</span>
    <span class="n">sci_ok_seg_name</span> <span class="o">=</span> <span class="s2">&quot;SCIENCE_OK&quot;</span>
    <span class="n">sci_ok_seg_dict</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>
    <span class="n">sci_ok_segs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">cat_sets</span> <span class="o">=</span> <span class="n">parse_cat_ini_opt</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s1">&#39;workflow-segments&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;segments-science-veto&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat_sets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Provide only 1 category group to determine&#39;</span>
                         <span class="s1">&#39; analyzable segments&#39;</span><span class="p">)</span>
    <span class="n">cat_set</span> <span class="o">=</span> <span class="n">cat_sets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ifos</span><span class="p">:</span>
        <span class="n">curr_segs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sci_segs</span><span class="p">[</span><span class="n">ifo</span><span class="p">])</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">cat_files</span><span class="o">.</span><span class="n">find_output_with_ifo</span><span class="p">(</span><span class="n">ifo</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">cat_set</span><span class="p">:</span>
            <span class="n">veto_def_cat</span> <span class="o">=</span> <span class="n">cat_to_veto_def_cat</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">find_output_with_tag</span><span class="p">(</span><span class="s1">&#39;VETO_CAT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">veto_def_cat</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Found more than one veto file for </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="p">,)</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;and category </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">category</span><span class="p">,)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Found no veto files for </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="p">,)</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;and category </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">category</span><span class="p">,)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="n">curr_veto_file</span> <span class="o">=</span> <span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cat_segs</span> <span class="o">=</span> <span class="n">curr_veto_file</span><span class="o">.</span><span class="n">return_union_seglist</span><span class="p">()</span>
            <span class="n">curr_segs</span> <span class="o">-=</span> <span class="n">cat_segs</span>
            <span class="n">curr_segs</span><span class="o">.</span><span class="n">coalesce</span><span class="p">()</span>
        <span class="n">sci_ok_seg_dict</span><span class="p">[</span><span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">sci_ok_seg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_segs</span>

    <span class="n">sci_ok_seg_file</span> <span class="o">=</span> <span class="n">SegFile</span><span class="o">.</span><span class="n">from_segment_list_dict</span><span class="p">(</span><span class="n">sci_ok_seg_name</span><span class="p">,</span>
                                          <span class="n">sci_ok_seg_dict</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">,</span>
                                          <span class="n">valid_segment</span><span class="o">=</span><span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">,</span>
                                          <span class="n">directory</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">has_option_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;segments-minimum-segment-length&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
        <span class="n">min_seg_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;segments-minimum-segment-length&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">sci_ok_seg_file</span><span class="o">.</span><span class="n">remove_short_sci_segs</span><span class="p">(</span><span class="n">min_seg_length</span><span class="p">)</span>

    <span class="c1"># FIXME: Another test we can do is limit to coinc time +/- some window</span>
    <span class="c1">#        this should *not* be set through segments-method, but currently</span>
    <span class="c1">#        is not implemented</span>
    <span class="c1">#segments_method = workflow.cp.get_opt_tags(&quot;workflow-segments&quot;,</span>
    <span class="c1">#                                  &quot;segments-method&quot;, tags)</span>
    <span class="c1">#if segments_method == &#39;ALL_SINGLE_IFO_TIME&#39;:</span>
    <span class="c1">#    pass</span>
    <span class="c1">#elif segments_method == &#39;COINC_TIME&#39;:</span>
    <span class="c1">#    cum_segs = None</span>
    <span class="c1">#    for ifo in sci_segs:</span>
    <span class="c1">#        if cum_segs is not None:</span>
    <span class="c1">#            cum_segs = (cum_segs &amp; sci_segs[ifo]).coalesce()</span>
    <span class="c1">#        else:</span>
    <span class="c1">#            cum_segs = sci_segs[ifo]</span>
    <span class="c1">#</span>
    <span class="c1">#    for ifo in sci_segs:</span>
    <span class="c1">#        sci_segs[ifo] = cum_segs</span>
    <span class="c1">#else:</span>
    <span class="c1">#    raise ValueError(&quot;Invalid segments-method, %s. Options are &quot;</span>
    <span class="c1">#                     &quot;ALL_SINGLE_IFO_TIME and COINC_TIME&quot; % segments_method)</span>

    <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ifos</span><span class="p">:</span>
        <span class="n">sci_ok_segs</span><span class="p">[</span><span class="n">ifo</span><span class="p">]</span> <span class="o">=</span> \
                      <span class="n">sci_ok_seg_file</span><span class="o">.</span><span class="n">segment_dict</span><span class="p">[</span><span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">sci_ok_seg_name</span><span class="p">]</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done generating analyzable science segments&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sci_ok_seg_file</span><span class="p">,</span> <span class="n">sci_ok_segs</span><span class="p">,</span> <span class="n">sci_ok_seg_name</span></div>


<div class="viewcode-block" id="get_cumulative_veto_group_files"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.get_cumulative_veto_group_files">[docs]</a><span class="k">def</span> <span class="nf">get_cumulative_veto_group_files</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">cat_files</span><span class="p">,</span>
                                    <span class="n">out_dir</span><span class="p">,</span> <span class="n">execute_now</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the cumulative veto files that define the different backgrounds</span>
<span class="sd">    we want to analyze, defined by groups of vetos.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    workflow : Workflow object</span>
<span class="sd">        Instance of the workflow object</span>
<span class="sd">    option : str</span>
<span class="sd">        ini file option to use to get the veto groups</span>
<span class="sd">    cat_files : FileList of SegFiles</span>
<span class="sd">        The category veto files generated by get_veto_segs</span>
<span class="sd">    out_dir : path</span>
<span class="sd">        Location to store output files</span>
<span class="sd">    execute_now : Boolean</span>
<span class="sd">        If true outputs are generated at runtime. Else jobs go into the workflow</span>
<span class="sd">        and are generated then.</span>
<span class="sd">    tags : list of strings</span>
<span class="sd">        Used to retrieve subsections of the ini file for</span>
<span class="sd">        configuration options.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    seg_files : workflow.core.FileList instance</span>
<span class="sd">        The cumulative segment files for each veto group.</span>
<span class="sd">    names : list of strings</span>
<span class="sd">        The segment names for the corresponding seg_file</span>
<span class="sd">    cat_files : workflow.core.FileList instance</span>
<span class="sd">        The list of individual category veto files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting generating vetoes for groups in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>
    <span class="n">make_analysis_dir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>

    <span class="n">cat_sets</span> <span class="o">=</span> <span class="n">parse_cat_ini_opt</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s1">&#39;workflow-segments&#39;</span><span class="p">,</span>
                                            <span class="n">option</span><span class="p">,</span> <span class="n">tags</span><span class="p">))</span>

    <span class="n">cum_seg_files</span> <span class="o">=</span> <span class="n">FileList</span><span class="p">()</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cat_set</span> <span class="ow">in</span> <span class="n">cat_sets</span><span class="p">:</span>
        <span class="n">segment_name</span> <span class="o">=</span> <span class="s2">&quot;CUMULATIVE_CAT_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cat_set</span><span class="p">)))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;getting information for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">segment_name</span><span class="p">)</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="n">cat_to_veto_def_cat</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cat_set</span><span class="p">]</span>

        <span class="n">cum_seg_files</span> <span class="o">+=</span> <span class="p">[</span><span class="n">get_cumulative_segs</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">cat_files</span><span class="p">,</span>
                          <span class="n">out_dir</span><span class="p">,</span> <span class="n">execute_now</span><span class="o">=</span><span class="n">execute_now</span><span class="p">,</span>
                          <span class="n">segment_name</span><span class="o">=</span><span class="n">segment_name</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)]</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment_name</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done generating vetoes for groups in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">cum_seg_files</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">cat_files</span></div>

<div class="viewcode-block" id="setup_segment_generation"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.setup_segment_generation">[docs]</a><span class="k">def</span> <span class="nf">setup_segment_generation</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is the gateway for setting up the segment generation steps in a</span>
<span class="sd">    workflow. It is designed to be able to support multiple ways of obtaining</span>
<span class="sd">    these segments and to combine/edit such files as necessary for analysis.</span>
<span class="sd">    The current modules have the capability to generate files at runtime or to</span>
<span class="sd">    generate files that are not needed for workflow generation within the workflow.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    workflow : pycbc.workflow.core.Workflow</span>
<span class="sd">        The workflow instance that the coincidence jobs will be added to.</span>
<span class="sd">        This instance also contains the ifos for which to attempt to obtain</span>
<span class="sd">        segments for this analysis and the start and end times to search for</span>
<span class="sd">        segments over.</span>
<span class="sd">    out_dir : path</span>
<span class="sd">        The directory in which output will be stored.</span>
<span class="sd">    tag : string, optional (default=None)</span>
<span class="sd">        Use this to specify a tag. This can be used if this module is being</span>
<span class="sd">        called more than once to give call specific configuration (by setting</span>
<span class="sd">        options in [workflow-datafind-${TAG}] rather than [workflow-datafind]). This</span>
<span class="sd">        is also used to tag the Files returned by the class to uniqueify</span>
<span class="sd">        the Files and uniqueify the actual filename.</span>
<span class="sd">        FIXME: Filenames may not be unique with current codes!</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    segsToAnalyse : dictionay of ifo-keyed glue.segment.segmentlist instances</span>
<span class="sd">        This will contain the times that your code should analyse. By default this</span>
<span class="sd">        is science time - CAT_1 vetoes. (This default could be changed if desired)</span>
<span class="sd">    segFilesList : pycbc.workflow.core.FileList of SegFile instances</span>
<span class="sd">        These are representations of the various segment files that were constructed</span>
<span class="sd">        at this stage of the workflow and may be needed at later stages of the</span>
<span class="sd">        analysis (e.g. for performing DQ vetoes). If the file was generated at</span>
<span class="sd">        run-time the segment lists contained within these files will be an attribute</span>
<span class="sd">        of the instance. (If it will be generated in the workflow it will not be</span>
<span class="sd">        because I am not psychic).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Entering segment generation module&quot;</span><span class="p">)</span>
    <span class="n">make_analysis_dir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>

    <span class="n">cp</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span>

    <span class="c1"># Parse for options in ini file</span>
    <span class="n">segmentsMethod</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;segments-method&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">tag</span><span class="p">])</span>
    <span class="c1"># These only needed if calling setup_segment_gen_mixed</span>
    <span class="k">if</span> <span class="n">segmentsMethod</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AT_RUNTIME&#39;</span><span class="p">,</span><span class="s1">&#39;CAT2_PLUS_DAG&#39;</span><span class="p">,</span><span class="s1">&#39;CAT3_PLUS_DAG&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;CAT4_PLUS_DAG&#39;</span><span class="p">]:</span>
        <span class="n">veto_cats</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;segments-veto-categories&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">tag</span><span class="p">])</span>
        <span class="n">max_veto_cat</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">veto_cats</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
        <span class="n">veto_categories</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_veto_cat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;segments-generate-coincident-segments&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">tag</span><span class="p">]):</span>
            <span class="n">generate_coincident_segs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generate_coincident_segs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Need to curl the veto-definer file</span>
        <span class="n">vetoDefUrl</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;segments-veto-definer-url&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">tag</span><span class="p">])</span>
        <span class="n">vetoDefBaseName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vetoDefUrl</span><span class="p">)</span>
        <span class="n">vetoDefNewPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">vetoDefBaseName</span><span class="p">)</span>
        <span class="n">resolve_url</span><span class="p">(</span><span class="n">vetoDefUrl</span><span class="p">,</span><span class="n">out_dir</span><span class="p">)</span>
        <span class="c1"># and update location</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span> <span class="s2">&quot;segments-veto-definer-file&quot;</span><span class="p">,</span>
                <span class="n">vetoDefNewPath</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;segments-minimum-segment-length&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">tag</span><span class="p">]):</span>
        <span class="n">minSegLength</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;segments-minimum-segment-length&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">tag</span><span class="p">])</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">minSegLength</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">segmentsMethod</span> <span class="o">==</span> <span class="s2">&quot;AT_RUNTIME&quot;</span><span class="p">:</span>
        <span class="n">max_veto</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="k">elif</span> <span class="n">segmentsMethod</span> <span class="o">==</span> <span class="s2">&quot;CAT2_PLUS_DAG&quot;</span><span class="p">:</span>
        <span class="n">max_veto</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">segmentsMethod</span> <span class="o">==</span> <span class="s2">&quot;CAT3_PLUS_DAG&quot;</span><span class="p">:</span>
        <span class="n">max_veto</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">segmentsMethod</span> <span class="o">==</span> <span class="s2">&quot;CAT4_PLUS_DAG&quot;</span><span class="p">:</span>
        <span class="n">max_veto</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Entry segments-method in [workflow-segments] does not have &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;expected value. Valid values are AT_RUNTIME, CAT4_PLUS_DAG, &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;CAT2_PLUS_DAG or CAT3_PLUS_DAG.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating segments with setup_segment_gen_mixed&quot;</span><span class="p">)</span>
    <span class="n">segFilesList</span> <span class="o">=</span> <span class="n">setup_segment_gen_mixed</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">veto_categories</span><span class="p">,</span>
                             <span class="n">out_dir</span><span class="p">,</span> <span class="n">max_veto</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                             <span class="n">generate_coincident_segs</span><span class="o">=</span><span class="n">generate_coincident_segs</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Segments obtained&quot;</span><span class="p">)</span>

    <span class="c1"># This creates the segsToAnalyse from the segFilesList. Currently it uses</span>
    <span class="c1"># the &#39;SCIENCE_OK&#39; segFilesList, which is science - CAT_1 in</span>
    <span class="c1"># setup_segment_gen_mixed.</span>
    <span class="c1"># This also applies the minimum science length</span>
    <span class="n">segsToAnalyse</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ifos</span><span class="p">:</span>
        <span class="n">analSegs</span> <span class="o">=</span> <span class="n">segFilesList</span><span class="o">.</span><span class="n">find_output_with_ifo</span><span class="p">(</span><span class="n">ifo</span><span class="p">)</span>
        <span class="n">analSegs</span> <span class="o">=</span> <span class="n">analSegs</span><span class="o">.</span><span class="n">find_output_with_tag</span><span class="p">(</span><span class="s1">&#39;SCIENCE_OK&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">analSegs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">analSegs</span> <span class="o">=</span> <span class="n">analSegs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">analSegs</span><span class="o">.</span><span class="n">segment_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">minSegLength</span><span class="p">:</span>
                <span class="n">analSegs</span><span class="o">.</span><span class="n">remove_short_sci_segs</span><span class="p">(</span><span class="n">minSegLength</span><span class="p">)</span>
                <span class="n">analSegs</span><span class="o">.</span><span class="n">to_segment_xml</span><span class="p">(</span><span class="n">override_file_if_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">segsToAnalyse</span><span class="p">[</span><span class="n">ifo</span><span class="p">]</span> <span class="o">=</span> <span class="n">analSegs</span><span class="o">.</span><span class="n">segment_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No science segments found for ifo </span><span class="si">%s</span><span class="s2">. &quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;If this is unexpected check the files that were dumped &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;in the </span><span class="si">%s</span><span class="s2"> directory. Also the &quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;commands that can be used to reproduce some of these &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;in </span><span class="si">%s</span><span class="s2">/*.sh&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="s1">&#39;logs&#39;</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Leaving segment generation module&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">segsToAnalyse</span><span class="p">,</span> <span class="n">segFilesList</span></div>

<div class="viewcode-block" id="setup_segment_gen_mixed"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.setup_segment_gen_mixed">[docs]</a><span class="k">def</span> <span class="nf">setup_segment_gen_mixed</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">veto_categories</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                            <span class="n">maxVetoAtRunTime</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">generate_coincident_segs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will generate veto files for each ifo and for each veto</span>
<span class="sd">    category.</span>
<span class="sd">    It can generate these vetoes at run-time or in the workflow (or do some at</span>
<span class="sd">    run-time and some in the workflow). However, the CAT_1 vetoes and science</span>
<span class="sd">    time must be generated at run time as they are needed to plan the workflow.</span>
<span class="sd">    CATs 2 and higher *may* be needed for other workflow construction.</span>
<span class="sd">    It can also combine these files to create a set of cumulative,</span>
<span class="sd">    multi-detector veto files, which can be used in ligolw_thinca and in</span>
<span class="sd">    pipedown. Again these can be created at run time or within the workflow.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    workflow : pycbc.workflow.core.Workflow</span>
<span class="sd">        The Workflow instance that the coincidence jobs will be added to.</span>
<span class="sd">        This instance also contains the ifos for which to attempt to obtain</span>
<span class="sd">        segments for this analysis and the start and end times to search for</span>
<span class="sd">        segments over.</span>
<span class="sd">    veto_categories : list of ints</span>
<span class="sd">        List of veto categories to generate segments for. If this stops being</span>
<span class="sd">        integers, this can be changed here.</span>
<span class="sd">    out_dir : path</span>
<span class="sd">        The directory in which output will be stored.</span>
<span class="sd">    maxVetoAtRunTime : int</span>
<span class="sd">        Generate veto files at run time up to this category. Veto categories</span>
<span class="sd">        beyond this in veto_categories will be generated in the workflow.</span>
<span class="sd">        If we move to a model where veto</span>
<span class="sd">        categories are not explicitly cumulative, this will be rethought.</span>
<span class="sd">    tag : string, optional (default=None)</span>
<span class="sd">        Use this to specify a tag. This can be used if this module is being</span>
<span class="sd">        called more than once to give call specific configuration (by setting</span>
<span class="sd">        options in [workflow-datafind-${TAG}] rather than [workflow-datafind]). This</span>
<span class="sd">        is also used to tag the Files returned by the class to uniqueify</span>
<span class="sd">        the Files and uniqueify the actual filename.</span>
<span class="sd">        FIXME: Filenames may not be unique with current codes!</span>
<span class="sd">    generate_coincident_segs : boolean, optional (default = True)</span>
<span class="sd">        If given this module will generate a set of coincident, cumulative veto</span>
<span class="sd">        files that can be used with ligolw_thinca and pipedown.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    segFilesList : dictionary of pycbc.workflow.core.SegFile instances</span>
<span class="sd">        These are representations of the various segment files that were</span>
<span class="sd">        constructed</span>
<span class="sd">        at this stage of the workflow and may be needed at later stages of the</span>
<span class="sd">        analysis (e.g. for performing DQ vetoes). If the file was generated at</span>
<span class="sd">        run-time the segment lists contained within these files will be an</span>
<span class="sd">        attribute</span>
<span class="sd">        of the instance. (If it will be generated in the workflow it will</span>
<span class="sd">        not be because I am not psychic).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span>
    <span class="n">segFilesList</span> <span class="o">=</span> <span class="n">FileList</span><span class="p">([])</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">segValidSeg</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span>
    <span class="c1"># Will I need to add some jobs to the workflow?</span>
    <span class="n">vetoGenJob</span> <span class="o">=</span> <span class="n">create_segs_from_cats_job</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ifo_string</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ifos</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating science segments for ifo </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="p">))</span>
        <span class="n">currSciSegs</span><span class="p">,</span> <span class="n">currSciXmlFile</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_sci_segs_for_ifo</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span>
                                        <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">segFilesList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currSciXmlFile</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">veto_categories</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">category</span> <span class="o">&gt;</span> <span class="n">maxVetoAtRunTime</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Adding creation of CAT_</span><span class="si">%d</span><span class="s2"> segments &quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;for ifo </span><span class="si">%s</span><span class="s2"> to workflow.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">execute_status</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">category</span> <span class="o">&lt;=</span> <span class="n">maxVetoAtRunTime</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating CAT_</span><span class="si">%d</span><span class="s2"> segments for ifo </span><span class="si">%s</span><span class="s2">.&quot;</span> \
                             <span class="o">%</span><span class="p">(</span><span class="n">category</span><span class="p">,</span><span class="n">ifo</span><span class="p">))</span>
                <span class="n">execute_status</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">currVetoXmlFile</span> <span class="o">=</span> <span class="n">get_veto_segs</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span>
                                                <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                                                <span class="n">vetoGenJob</span><span class="p">,</span>
                                                <span class="n">execute_now</span><span class="o">=</span><span class="n">execute_status</span><span class="p">)</span>

            <span class="n">segFilesList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currVetoXmlFile</span><span class="p">)</span>
            <span class="c1"># Store the CAT_1 veto segs for use below</span>
            <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cat1Segs</span> <span class="o">=</span> <span class="n">currVetoXmlFile</span><span class="o">.</span><span class="n">return_union_seglist</span><span class="p">()</span>

        <span class="n">analysedSegs</span> <span class="o">=</span> <span class="n">currSciSegs</span> <span class="o">-</span> <span class="n">cat1Segs</span>
        <span class="n">analysedSegs</span><span class="o">.</span><span class="n">coalesce</span><span class="p">()</span>
        <span class="n">analysedSegDict</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>
        <span class="n">analysedSegDict</span><span class="p">[</span><span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:SCIENCE_OK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysedSegs</span>
        <span class="n">analysedXmlFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span>
                             <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-SCIENCE_OK_SEGMENTS.xml&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span> <span class="p">)</span>
        <span class="n">currUrl</span> <span class="o">=</span> <span class="n">urlunparse</span><span class="p">([</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">analysedXmlFile</span><span class="p">,</span>
                              <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">currTags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="p">,</span> <span class="s1">&#39;SCIENCE_OK&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">currTags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SCIENCE_OK&#39;</span><span class="p">]</span>
        <span class="n">currFile</span> <span class="o">=</span> <span class="n">SegFile</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span> <span class="s1">&#39;SEGMENTS&#39;</span><span class="p">,</span> <span class="n">analysedSegs</span><span class="p">,</span>
                           <span class="n">segment_dict</span><span class="o">=</span><span class="n">analysedSegDict</span><span class="p">,</span> <span class="n">file_url</span><span class="o">=</span><span class="n">currUrl</span><span class="p">,</span>
                           <span class="n">tags</span><span class="o">=</span><span class="n">currTags</span><span class="p">)</span>
        <span class="n">segFilesList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currFile</span><span class="p">)</span>
        <span class="n">currFile</span><span class="o">.</span><span class="n">to_segment_xml</span><span class="p">()</span>


    <span class="k">if</span> <span class="n">generate_coincident_segs</span><span class="p">:</span>
        <span class="c1"># Need to make some combined category veto files to use when vetoing</span>
        <span class="c1"># segments and triggers.</span>
        <span class="n">ifo_string</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ifo_string</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cum_cat_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">veto_categories</span><span class="p">:</span>
            <span class="n">categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
            <span class="c1"># Set file name in workflow standard</span>
            <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
                <span class="n">currTags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">currTags</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># And actually make the file (or queue it in the workflow)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating combined, cumulative CAT_</span><span class="si">%d</span><span class="s2"> segments.&quot;</span>\
                             <span class="o">%</span><span class="p">(</span><span class="n">category</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">category</span> <span class="o">&lt;=</span> <span class="n">maxVetoAtRunTime</span><span class="p">:</span>
                <span class="n">execute_status</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">execute_status</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">currSegFile</span> <span class="o">=</span> <span class="n">get_cumulative_segs</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span>
                                <span class="n">segFilesList</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                                <span class="n">execute_now</span><span class="o">=</span><span class="n">execute_status</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">currTags</span><span class="p">)</span>

            <span class="n">segFilesList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currSegFile</span><span class="p">)</span>
            <span class="n">cum_cat_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currSegFile</span><span class="p">)</span>
        <span class="c1"># Create a combined file</span>
        <span class="c1"># Set file tag in workflow standard</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">currTags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="p">,</span> <span class="s1">&#39;COMBINED_CUMULATIVE_SEGMENTS&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">currTags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;COMBINED_CUMULATIVE_SEGMENTS&#39;</span><span class="p">]</span>

        <span class="n">combined_veto_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span>
                               <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-CUMULATIVE_ALL_CATS_SEGMENTS.xml&#39;</span> \
                               <span class="o">%</span><span class="p">(</span><span class="n">ifo_string</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">curr_url</span> <span class="o">=</span> <span class="n">urlunparse</span><span class="p">([</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                               <span class="n">combined_veto_file</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">curr_file</span> <span class="o">=</span> <span class="n">SegFile</span><span class="p">(</span><span class="n">ifo_string</span><span class="p">,</span> <span class="s1">&#39;SEGMENTS&#39;</span><span class="p">,</span> <span class="n">segValidSeg</span><span class="p">,</span>
                            <span class="n">file_url</span><span class="o">=</span><span class="n">curr_url</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">currTags</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">veto_categories</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">category</span> <span class="o">&lt;=</span> <span class="n">maxVetoAtRunTime</span><span class="p">:</span>
                <span class="n">execute_status</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">execute_status</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">add_cumulative_files</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">curr_file</span><span class="p">,</span> <span class="n">cum_cat_files</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                             <span class="n">execute_now</span><span class="o">=</span><span class="n">execute_status</span><span class="p">)</span>
        <span class="n">segFilesList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">segFilesList</span></div>

<div class="viewcode-block" id="get_sci_segs_for_ifo"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.get_sci_segs_for_ifo">[docs]</a><span class="k">def</span> <span class="nf">get_sci_segs_for_ifo</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain science segments for the selected ifo</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    ifo : string</span>
<span class="sd">        The string describing the ifo to obtain science times for.</span>
<span class="sd">    start_time : gps time (either int/LIGOTimeGPS)</span>
<span class="sd">        The time at which to begin searching for segments.</span>
<span class="sd">    end_time : gps time (either int/LIGOTimeGPS)</span>
<span class="sd">        The time at which to stop searching for segments.</span>
<span class="sd">    out_dir : path</span>
<span class="sd">        The directory in which output will be stored.</span>
<span class="sd">    tag : string, optional (default=None)</span>
<span class="sd">        Use this to specify a tag. This can be used if this module is being</span>
<span class="sd">        called more than once to give call specific configuration (by setting</span>
<span class="sd">        options in [workflow-datafind-${TAG}] rather than [workflow-datafind]).</span>
<span class="sd">        This is also used to tag the Files returned by the class to uniqueify</span>
<span class="sd">        the Files and uniqueify the actual filename.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    sci_segs : ligo.segments.segmentlist</span>
<span class="sd">        The segmentlist generated by this call</span>
<span class="sd">    sci_xml_file : pycbc.workflow.core.SegFile</span>
<span class="sd">        The workflow File object corresponding to this science segments file.</span>
<span class="sd">    out_sci_seg_name : string</span>
<span class="sd">        The name of the output segment list in the output XML file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seg_valid_seg</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">([</span><span class="n">start_time</span><span class="p">,</span><span class="n">end_time</span><span class="p">])</span>
    <span class="n">sci_seg_name</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span>
        <span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span> <span class="s2">&quot;segments-</span><span class="si">%s</span><span class="s2">-science-name&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span> <span class="n">tags</span><span class="p">)</span>
    <span class="n">sci_seg_url</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span>
        <span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span> <span class="s2">&quot;segments-database-url&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
    <span class="c1"># NOTE: ligolw_segment_query returns slightly strange output. The output</span>
    <span class="c1">#       segment list is put in with name &quot;RESULT&quot;. So this is hardcoded here</span>
    <span class="n">out_sci_seg_name</span> <span class="o">=</span> <span class="s2">&quot;RESULT&quot;</span>
    <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
        <span class="n">sci_xml_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-SCIENCE_SEGMENTS_</span><span class="si">%s</span><span class="s2">.xml&quot;</span> \
                     <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tags</span><span class="p">)))</span>
        <span class="n">tag_list</span><span class="o">=</span><span class="n">tags</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SCIENCE&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sci_xml_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-SCIENCE_SEGMENTS.xml&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span> <span class="p">)</span>
        <span class="n">tag_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SCIENCE&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">file_needs_generating</span><span class="p">(</span><span class="n">sci_xml_file_path</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">):</span>
        <span class="n">seg_find_call</span> <span class="o">=</span> <span class="p">[</span> <span class="n">resolve_url</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;executables&quot;</span><span class="p">,</span><span class="s2">&quot;segment_query&quot;</span><span class="p">),</span>
                <span class="n">permissions</span><span class="o">=</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXUSR</span><span class="p">),</span>
            <span class="s2">&quot;--query-segments&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--segment-url&quot;</span><span class="p">,</span> <span class="n">sci_seg_url</span><span class="p">,</span>
            <span class="s2">&quot;--gps-start-time&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_time</span><span class="p">),</span>
            <span class="s2">&quot;--gps-end-time&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_time</span><span class="p">),</span>
            <span class="s2">&quot;--include-segments&quot;</span><span class="p">,</span> <span class="n">sci_seg_name</span><span class="p">,</span>
            <span class="s2">&quot;--output-file&quot;</span><span class="p">,</span> <span class="n">sci_xml_file_path</span> <span class="p">]</span>

        <span class="n">make_external_call</span><span class="p">(</span><span class="n">seg_find_call</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="s1">&#39;logs&#39;</span><span class="p">),</span>
                                <span class="n">out_basename</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-science-call&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="p">)</span>

    <span class="c1"># Yes its yucky to generate a file and then read it back in.</span>
    <span class="n">sci_xml_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sci_xml_file_path</span><span class="p">)</span>
    <span class="n">sci_xml_file</span> <span class="o">=</span> <span class="n">SegFile</span><span class="o">.</span><span class="n">from_segment_xml</span><span class="p">(</span><span class="n">sci_xml_file_path</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tag_list</span><span class="p">,</span>
                                        <span class="n">valid_segment</span><span class="o">=</span><span class="n">seg_valid_seg</span><span class="p">)</span>
    <span class="c1"># NOTE: ligolw_segment_query returns slightly strange output. The output</span>
    <span class="c1">#       segment_summary output does not use RESULT. Therefore move the</span>
    <span class="c1">#       segment_summary across.</span>
    <span class="n">sci_xml_file</span><span class="o">.</span><span class="n">seg_summ_dict</span><span class="p">[</span><span class="n">ifo</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">out_sci_seg_name</span><span class="p">]</span> <span class="o">=</span> \
             <span class="n">sci_xml_file</span><span class="o">.</span><span class="n">seg_summ_dict</span><span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sci_seg_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])]</span>

    <span class="n">sci_segs</span> <span class="o">=</span> <span class="n">sci_xml_file</span><span class="o">.</span><span class="n">return_union_seglist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">sci_segs</span><span class="p">,</span> <span class="n">sci_xml_file</span><span class="p">,</span> <span class="n">out_sci_seg_name</span></div>

<div class="viewcode-block" id="get_veto_segs"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.get_veto_segs">[docs]</a><span class="k">def</span> <span class="nf">get_veto_segs</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                  <span class="n">veto_gen_job</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">execute_now</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain veto segments for the selected ifo and veto category and add the job</span>
<span class="sd">    to generate this to the workflow.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    workflow: pycbc.workflow.core.Workflow</span>
<span class="sd">        An instance of the Workflow class that manages the workflow.</span>
<span class="sd">    ifo : string</span>
<span class="sd">        The string describing the ifo to generate vetoes for.</span>
<span class="sd">    category : int</span>
<span class="sd">        The veto category to generate vetoes for.</span>
<span class="sd">    start_time : gps time (either int/LIGOTimeGPS)</span>
<span class="sd">        The time at which to begin searching for segments.</span>
<span class="sd">    end_time : gps time (either int/LIGOTimeGPS)</span>
<span class="sd">        The time at which to stop searching for segments.</span>
<span class="sd">    out_dir : path</span>
<span class="sd">        The directory in which output will be stored.</span>
<span class="sd">    vetoGenJob : Job</span>
<span class="sd">        The veto generation Job class that will be used to create the Node.</span>
<span class="sd">    tag : string, optional (default=None)</span>
<span class="sd">        Use this to specify a tag. This can be used if this module is being</span>
<span class="sd">        called more than once to give call specific configuration (by setting</span>
<span class="sd">        options in [workflow-datafind-${TAG}] rather than [workflow-datafind]).</span>
<span class="sd">        This is also used to tag the Files returned by the class to uniqueify</span>
<span class="sd">        the Files and uniqueify the actual filename.</span>
<span class="sd">        FIXME: Filenames may not be unique with current codes!</span>
<span class="sd">    execute_now : boolean, optional</span>
<span class="sd">        If true, jobs are executed immediately. If false, they are added to the</span>
<span class="sd">        workflow to be run later.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    veto_def_file : pycbc.workflow.core.SegFile</span>
<span class="sd">        The workflow File object corresponding to this DQ veto file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seg_valid_seg</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">([</span><span class="n">start_time</span><span class="p">,</span><span class="n">end_time</span><span class="p">])</span>
    <span class="c1"># FIXME: This job needs an internet connection and X509_USER_PROXY</span>
    <span class="c1">#        For internet connection, it may need a headnode (ie universe local)</span>
    <span class="c1">#        For X509_USER_PROXY, I don&#39;t know what pegasus is doing</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">veto_gen_job</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">add_opt</span><span class="p">(</span><span class="s1">&#39;--veto-categories&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">category</span><span class="p">))</span>
    <span class="n">node</span><span class="o">.</span><span class="n">add_opt</span><span class="p">(</span><span class="s1">&#39;--ifo-list&#39;</span><span class="p">,</span> <span class="n">ifo</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">add_opt</span><span class="p">(</span><span class="s1">&#39;--gps-start-time&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_time</span><span class="p">))</span>
    <span class="n">node</span><span class="o">.</span><span class="n">add_opt</span><span class="p">(</span><span class="s1">&#39;--gps-end-time&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_time</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
        <span class="n">veto_xml_file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-VETOTIME_CAT</span><span class="si">%d</span><span class="s2">_</span><span class="si">%s</span><span class="s2">-</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">.xml&quot;</span> \
                               <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tags</span><span class="p">),</span> <span class="n">start_time</span><span class="p">,</span>
                                 <span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">veto_xml_file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-VETOTIME_CAT</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">.xml&quot;</span> \
                         <span class="o">%</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>
    <span class="n">veto_xml_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span>
                                         <span class="n">veto_xml_file_name</span><span class="p">))</span>
    <span class="n">curr_url</span> <span class="o">=</span> <span class="n">urlunparse</span><span class="p">([</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                           <span class="n">veto_xml_file_path</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
        <span class="n">curr_tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;VETO_CAT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">category</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curr_tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;VETO_CAT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">category</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">file_needs_generating</span><span class="p">(</span><span class="n">veto_xml_file_path</span><span class="p">,</span> <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">execute_now</span><span class="p">:</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">execute_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">verbatim_exe</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">veto_xml_file</span> <span class="o">=</span> <span class="n">SegFile</span><span class="o">.</span><span class="n">from_segment_xml</span><span class="p">(</span><span class="n">veto_xml_file_path</span><span class="p">,</span>
                                                 <span class="n">tags</span><span class="o">=</span><span class="n">curr_tags</span><span class="p">,</span>
                                                 <span class="n">valid_segment</span><span class="o">=</span><span class="n">seg_valid_seg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">veto_xml_file</span> <span class="o">=</span> <span class="n">SegFile</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span> <span class="s1">&#39;SEGMENTS&#39;</span><span class="p">,</span> <span class="n">seg_valid_seg</span><span class="p">,</span>
                                    <span class="n">file_url</span><span class="o">=</span><span class="n">curr_url</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">curr_tags</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">_add_output</span><span class="p">(</span><span class="n">veto_xml_file</span><span class="p">)</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">executed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">fil</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">_outputs</span><span class="p">:</span>
            <span class="n">fil</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">veto_xml_file</span> <span class="o">=</span> <span class="n">SegFile</span><span class="o">.</span><span class="n">from_segment_xml</span><span class="p">(</span><span class="n">veto_xml_file_path</span><span class="p">,</span>
                                                 <span class="n">tags</span><span class="o">=</span><span class="n">curr_tags</span><span class="p">,</span>
                                                 <span class="n">valid_segment</span><span class="o">=</span><span class="n">seg_valid_seg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">veto_xml_file</span></div>

<div class="viewcode-block" id="create_segs_from_cats_job"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.create_segs_from_cats_job">[docs]</a><span class="k">def</span> <span class="nf">create_segs_from_cats_job</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">ifo_string</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates the CondorDAGJob that will be used to run</span>
<span class="sd">    ligolw_segments_from_cats as part of the workflow</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    cp : pycbc.workflow.configuration.WorkflowConfigParser</span>
<span class="sd">        The in-memory representation of the configuration (.ini) files</span>
<span class="sd">    out_dir : path</span>
<span class="sd">        Directory in which to put output files</span>
<span class="sd">    ifo_string : string</span>
<span class="sd">        String containing all active ifos, ie. &quot;H1L1V1&quot;</span>
<span class="sd">    tag : list of strings, optional (default=None)</span>
<span class="sd">        Use this to specify a tag(s). This can be used if this module is being</span>
<span class="sd">        called more than once to give call specific configuration (by setting</span>
<span class="sd">        options in [workflow-datafind-${TAG}] rather than [workflow-datafind]).</span>
<span class="sd">        This is also used to tag the Files returned by the class to uniqueify</span>
<span class="sd">        the Files and uniqueify the actual filename.</span>
<span class="sd">        FIXME: Filenames may not be unique with current codes!</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    job : Job instance</span>
<span class="sd">        The Job instance that will run segments_from_cats jobs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">seg_server_url</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;segments-database-url&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
    <span class="n">veto_def_file</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;segments-veto-definer-file&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>

    <span class="n">job</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s1">&#39;segments_from_cats&#39;</span><span class="p">,</span> <span class="n">universe</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span>
                               <span class="n">ifos</span><span class="o">=</span><span class="n">ifo_string</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">add_opt</span><span class="p">(</span><span class="s1">&#39;--separate-categories&#39;</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">add_opt</span><span class="p">(</span><span class="s1">&#39;--segment-url&#39;</span><span class="p">,</span> <span class="n">seg_server_url</span><span class="p">)</span>

    <span class="n">job</span><span class="o">.</span><span class="n">add_opt</span><span class="p">(</span><span class="s1">&#39;--veto-file&#39;</span><span class="p">,</span> <span class="n">veto_def_file</span><span class="p">)</span>
    <span class="c1"># FIXME: Would like the proxy in the Workflow instance</span>
    <span class="c1"># FIXME: Explore using the x509 condor commands</span>
    <span class="c1"># If the user has a proxy set in the environment, add it to the job</span>
    <span class="k">return</span> <span class="n">job</span></div>

<div class="viewcode-block" id="get_cumulative_segs"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.get_cumulative_segs">[docs]</a><span class="k">def</span> <span class="nf">get_cumulative_segs</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">seg_files_list</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                        <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">execute_now</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">segment_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to generate one of the cumulative, multi-detector segment files</span>
<span class="sd">    as part of the workflow.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    workflow: pycbc.workflow.core.Workflow</span>
<span class="sd">        An instance of the Workflow class that manages the workflow.</span>
<span class="sd">    categories : int</span>
<span class="sd">        The veto categories to include in this cumulative veto.</span>
<span class="sd">    seg_files_list : Listionary of SegFiles</span>
<span class="sd">        The list of segment files to be used as input for combining.</span>
<span class="sd">    out_dir : path</span>
<span class="sd">        The directory to write output to.</span>
<span class="sd">    tags : list of strings, optional</span>
<span class="sd">        A list of strings that is used to identify this job</span>
<span class="sd">    execute_now : boolean, optional</span>
<span class="sd">        If true, jobs are executed immediately. If false, they are added to the</span>
<span class="sd">        workflow to be run later.</span>
<span class="sd">    segment_name : str</span>
<span class="sd">        The name of the combined, cumulative segments in the output file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">add_inputs</span> <span class="o">=</span> <span class="n">FileList</span><span class="p">([])</span>
    <span class="n">valid_segment</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span>
    <span class="k">if</span> <span class="n">segment_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">segment_name</span> <span class="o">=</span> <span class="s1">&#39;VETO_CAT</span><span class="si">%d</span><span class="s1">_CUMULATIVE&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">categories</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span>
    <span class="c1"># calculate the cumulative veto files for a given ifo</span>
    <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ifos</span><span class="p">:</span>
        <span class="n">cum_job</span> <span class="o">=</span> <span class="n">LigoLWCombineSegsExecutable</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s1">&#39;ligolw_combine_segments&#39;</span><span class="p">,</span>
                       <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">segment_name</span><span class="p">]</span><span class="o">+</span><span class="n">tags</span><span class="p">,</span> <span class="n">ifos</span><span class="o">=</span><span class="n">ifo</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">seg_files_list</span><span class="o">.</span><span class="n">find_output_with_ifo</span><span class="p">(</span><span class="n">ifo</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">find_output_with_tag</span><span class="p">(</span><span class="s1">&#39;VETO_CAT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">category</span><span class="p">))</span>
            <span class="n">inputs</span><span class="o">+=</span><span class="n">file_list</span>

        <span class="n">cum_node</span>  <span class="o">=</span> <span class="n">cum_job</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">valid_segment</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">segment_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_needs_generating</span><span class="p">(</span><span class="n">cum_node</span><span class="o">.</span><span class="n">output_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cache_entry</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                 <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">execute_now</span><span class="p">:</span>
                <span class="n">workflow</span><span class="o">.</span><span class="n">execute_node</span><span class="p">(</span><span class="n">cum_node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">cum_node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cum_node</span><span class="o">.</span><span class="n">executed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">fil</span> <span class="ow">in</span> <span class="n">cum_node</span><span class="o">.</span><span class="n">_outputs</span><span class="p">:</span>
                <span class="n">fil</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">fil</span><span class="o">.</span><span class="n">PFN</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="s1">&#39;file:&#39;</span><span class="p">,</span> <span class="n">pathname2url</span><span class="p">(</span><span class="n">fil</span><span class="o">.</span><span class="n">storage_path</span><span class="p">)),</span>
                        <span class="n">site</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
        <span class="n">add_inputs</span> <span class="o">+=</span> <span class="n">cum_node</span><span class="o">.</span><span class="n">output_files</span>

    <span class="c1"># add cumulative files for each ifo together</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_VETO_SEGMENTS&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">segment_name</span><span class="p">)</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">ifos</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">,</span>
                                            <span class="n">directory</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">,</span>
                                            <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">segment_name</span><span class="p">]</span> <span class="o">+</span> <span class="n">tags</span><span class="p">)</span>
    <span class="n">add_job</span> <span class="o">=</span> <span class="n">LigolwAddExecutable</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s1">&#39;llwadd&#39;</span><span class="p">,</span> <span class="n">ifos</span><span class="o">=</span><span class="n">ifo</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
                                  <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
    <span class="n">add_node</span> <span class="o">=</span> <span class="n">add_job</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">valid_segment</span><span class="p">,</span> <span class="n">add_inputs</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file_needs_generating</span><span class="p">(</span><span class="n">add_node</span><span class="o">.</span><span class="n">output_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cache_entry</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                             <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">execute_now</span><span class="p">:</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">execute_node</span><span class="p">(</span><span class="n">add_node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">add_node</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">add_node</span><span class="o">.</span><span class="n">executed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">fil</span> <span class="ow">in</span> <span class="n">add_node</span><span class="o">.</span><span class="n">_outputs</span><span class="p">:</span>
            <span class="n">fil</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">fil</span><span class="o">.</span><span class="n">PFN</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="s1">&#39;file:&#39;</span><span class="p">,</span> <span class="n">pathname2url</span><span class="p">(</span><span class="n">fil</span><span class="o">.</span><span class="n">storage_path</span><span class="p">)),</span>
                    <span class="n">site</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outfile</span></div>

<div class="viewcode-block" id="add_cumulative_files"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.add_cumulative_files">[docs]</a><span class="k">def</span> <span class="nf">add_cumulative_files</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">input_files</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span>
                         <span class="n">execute_now</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to combine a set of segment files into a single one. This function</span>
<span class="sd">    will not merge the segment lists but keep each separate.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    workflow: pycbc.workflow.core.Workflow</span>
<span class="sd">        An instance of the Workflow class that manages the workflow.</span>
<span class="sd">    output_file: pycbc.workflow.core.File</span>
<span class="sd">        The output file object</span>
<span class="sd">    input_files: pycbc.workflow.core.FileList</span>
<span class="sd">        This list of input segment files</span>
<span class="sd">    out_dir : path</span>
<span class="sd">        The directory to write output to.</span>
<span class="sd">    execute_now : boolean, optional</span>
<span class="sd">        If true, jobs are executed immediately. If false, they are added to the</span>
<span class="sd">        workflow to be run later.</span>
<span class="sd">    tags : list of strings, optional</span>
<span class="sd">        A list of strings that is used to identify this job</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">llwadd_job</span> <span class="o">=</span> <span class="n">LigolwAddExecutable</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="s1">&#39;llwadd&#39;</span><span class="p">,</span>
                       <span class="n">ifo</span><span class="o">=</span><span class="n">output_file</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
    <span class="n">add_node</span> <span class="o">=</span> <span class="n">llwadd_job</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">output_file</span><span class="o">.</span><span class="n">segment</span><span class="p">,</span> <span class="n">input_files</span><span class="p">,</span>
                                   <span class="n">output</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file_needs_generating</span><span class="p">(</span><span class="n">add_node</span><span class="o">.</span><span class="n">output_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cache_entry</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                             <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">execute_now</span><span class="p">:</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">execute_node</span><span class="p">(</span><span class="n">add_node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">add_node</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">add_node</span><span class="o">.</span><span class="n">executed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">fil</span> <span class="ow">in</span> <span class="n">add_node</span><span class="o">.</span><span class="n">_outputs</span><span class="p">:</span>
            <span class="n">fil</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">fil</span><span class="o">.</span><span class="n">PFN</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="s1">&#39;file:&#39;</span><span class="p">,</span> <span class="n">pathname2url</span><span class="p">(</span><span class="n">fil</span><span class="o">.</span><span class="n">storage_path</span><span class="p">)),</span>
                    <span class="n">site</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">add_node</span><span class="o">.</span><span class="n">output_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="find_playground_segments"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.find_playground_segments">[docs]</a><span class="k">def</span> <span class="nf">find_playground_segments</span><span class="p">(</span><span class="n">segs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Finds playground time in a list of segments.</span>

<span class="sd">      Playground segments include the first 600s of every 6370s stride starting</span>
<span class="sd">      at GPS time 729273613.</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>
<span class="sd">      segs : segmentfilelist</span>
<span class="sd">          A segmentfilelist to find playground segments.</span>

<span class="sd">      Returns</span>
<span class="sd">      -------</span>
<span class="sd">      outlist : segmentfilelist</span>
<span class="sd">          A segmentfilelist with all playground segments during the input</span>
<span class="sd">          segmentfilelist (ie. segs).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># initializations</span>
    <span class="n">start_s2</span> <span class="o">=</span> <span class="mi">729273613</span>
    <span class="n">playground_stride</span> <span class="o">=</span> <span class="mi">6370</span>
    <span class="n">playground_length</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="n">outlist</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">()</span>

    <span class="c1"># loop over segments</span>
    <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">segs</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># the first playground segment whose end is after the start of seg</span>
        <span class="n">playground_start</span> <span class="o">=</span> <span class="n">start_s2</span> <span class="o">+</span> <span class="n">playground_stride</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> \
                     <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="o">-</span><span class="n">start_s2</span><span class="o">-</span><span class="n">playground_length</span><span class="p">)</span> <span class="o">/</span> <span class="n">playground_stride</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">playground_start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="c1"># find start of playground segment</span>
            <span class="k">if</span> <span class="n">playground_start</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                <span class="n">ostart</span> <span class="o">=</span> <span class="n">playground_start</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ostart</span> <span class="o">=</span> <span class="n">start</span>

            <span class="n">playground_end</span> <span class="o">=</span> <span class="n">playground_start</span> <span class="o">+</span> <span class="n">playground_length</span>

            <span class="c1"># find end of playground segment</span>
            <span class="k">if</span> <span class="n">playground_end</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
                <span class="n">oend</span> <span class="o">=</span> <span class="n">playground_end</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">oend</span> <span class="o">=</span> <span class="n">end</span>

            <span class="c1"># append segment</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">ostart</span><span class="p">,</span> <span class="n">oend</span><span class="p">)</span>
            <span class="n">outlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="c1"># increment</span>
            <span class="n">playground_start</span> <span class="o">=</span> <span class="n">playground_start</span> <span class="o">+</span> <span class="n">playground_stride</span>

    <span class="k">return</span> <span class="n">outlist</span></div>

<div class="viewcode-block" id="get_triggered_coherent_segment"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.get_triggered_coherent_segment">[docs]</a><span class="k">def</span> <span class="nf">get_triggered_coherent_segment</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">sciencesegs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct the coherent network on and off source segments. Can switch to</span>
<span class="sd">    construction of segments for a single IFO search when coherent segments</span>
<span class="sd">    are insufficient for a search.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    workflow : pycbc.workflow.core.Workflow</span>
<span class="sd">        The workflow instance that the calculated segments belong to.</span>
<span class="sd">    sciencesegs : dict</span>
<span class="sd">        Dictionary of all science segments within analysis time.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    onsource : ligo.segments.segmentlistdict</span>
<span class="sd">        A dictionary containing the on source segments for network IFOs</span>

<span class="sd">    offsource : ligo.segments.segmentlistdict</span>
<span class="sd">        A dictionary containing the off source segments for network IFOs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Load parsed workflow config options</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span>
    <span class="n">triggertime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow&#39;</span><span class="p">,</span> <span class="s1">&#39;trigger-time&#39;</span><span class="p">)))</span>
    <span class="n">minduration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;min-duration&#39;</span><span class="p">)))</span>
    <span class="n">maxduration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;max-duration&#39;</span><span class="p">)))</span>
    <span class="n">onbefore</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;on-before&#39;</span><span class="p">)))</span>
    <span class="n">onafter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;on-after&#39;</span><span class="p">)))</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;pad-data&#39;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;workflow-condition_strain&quot;</span><span class="p">,</span> <span class="s2">&quot;do-gating&quot;</span><span class="p">):</span>
        <span class="n">padding</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;condition_strain&quot;</span><span class="p">,</span>
                                               <span class="s2">&quot;pad-data&quot;</span><span class="p">)))</span>
    <span class="n">quanta</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;quanta&#39;</span><span class="p">)))</span>

    <span class="c1"># Check available data segments meet criteria specified in arguments</span>
    <span class="n">commonsegs</span> <span class="o">=</span> <span class="n">sciencesegs</span><span class="o">.</span><span class="n">extract_common</span><span class="p">(</span><span class="n">sciencesegs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">offsrclist</span> <span class="o">=</span> <span class="n">commonsegs</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">commonsegs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsrclist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing network segments that do not contain trigger &quot;</span>
                     <span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">offsrclist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">triggertime</span> <span class="ow">in</span> <span class="n">seg</span><span class="p">:</span>
                <span class="n">offsrc</span> <span class="o">=</span> <span class="n">seg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">offsrc</span> <span class="o">=</span> <span class="n">offsrclist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">offsrc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minduration</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span><span class="p">:</span>
        <span class="n">fail</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">([</span><span class="n">triggertime</span> <span class="o">-</span> <span class="n">minduration</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="n">padding</span><span class="p">,</span>
                                 <span class="n">triggertime</span> <span class="o">+</span> <span class="n">minduration</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">padding</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Available network segment shorter than minimum &quot;</span>
                        <span class="s2">&quot;allowed duration.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fail</span>

    <span class="c1"># Will segment duration be the maximum desired length or not?</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">offsrc</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">maxduration</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Available network science segment duration (</span><span class="si">%d</span><span class="s2">s) is &quot;</span>
                     <span class="s2">&quot;greater than the maximum allowed segment length (</span><span class="si">%d</span><span class="s2">s). &quot;</span>
                     <span class="s2">&quot;Truncating...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">offsrc</span><span class="p">),</span> <span class="n">maxduration</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Available network science segment duration (</span><span class="si">%d</span><span class="s2">s) is &quot;</span>
                     <span class="s2">&quot;less than the maximum allowed segment length (</span><span class="si">%d</span><span class="s2">s).&quot;</span>
                     <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">offsrc</span><span class="p">),</span> <span class="n">maxduration</span><span class="p">))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">s of padding applied at beginning and end of segment.&quot;</span>
                 <span class="o">%</span> <span class="n">padding</span><span class="p">)</span>


    <span class="c1"># Construct on-source</span>
    <span class="n">onstart</span> <span class="o">=</span> <span class="n">triggertime</span> <span class="o">-</span> <span class="n">onbefore</span>
    <span class="n">onend</span> <span class="o">=</span> <span class="n">triggertime</span> <span class="o">+</span> <span class="n">onafter</span>
    <span class="n">oncentre</span> <span class="o">=</span> <span class="n">onstart</span> <span class="o">+</span> <span class="p">((</span><span class="n">onbefore</span> <span class="o">+</span> <span class="n">onafter</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">onsrc</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">onstart</span><span class="p">,</span> <span class="n">onend</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Constructed ON-SOURCE: duration </span><span class="si">%d</span><span class="s2">s (</span><span class="si">%d</span><span class="s2">s before to </span><span class="si">%d</span><span class="s2">s after&quot;</span>
                 <span class="s2">&quot; trigger).&quot;</span>
                 <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">onsrc</span><span class="p">),</span> <span class="n">triggertime</span> <span class="o">-</span> <span class="n">onsrc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">onsrc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">triggertime</span><span class="p">))</span>
    <span class="n">onsrc</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">([</span><span class="n">onsrc</span><span class="p">])</span>

    <span class="c1"># Maximal, centred coherent network segment</span>
    <span class="n">idealsegment</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">oncentre</span> <span class="o">-</span> <span class="n">padding</span> <span class="o">-</span>
                                    <span class="mf">0.5</span> <span class="o">*</span> <span class="n">maxduration</span><span class="p">),</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">oncentre</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span>
                                    <span class="mf">0.5</span> <span class="o">*</span> <span class="n">maxduration</span><span class="p">))</span>

    <span class="c1"># Construct off-source</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">idealsegment</span> <span class="ow">in</span> <span class="n">offsrc</span><span class="p">):</span>
        <span class="n">offsrc</span> <span class="o">=</span> <span class="n">idealsegment</span>

    <span class="k">elif</span> <span class="n">idealsegment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">offsrc</span><span class="p">:</span>
        <span class="n">offsrc</span> <span class="o">&amp;=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">offsrc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">maxduration</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span><span class="p">,</span>
                                   <span class="n">offsrc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">idealsegment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">offsrc</span><span class="p">:</span>
        <span class="n">offsrc</span> <span class="o">&amp;=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">offsrc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">offsrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">maxduration</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span><span class="p">)</span>

    <span class="c1"># Trimming off-source</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">offsrc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span><span class="p">)</span> <span class="o">%</span> <span class="n">quanta</span>
    <span class="k">if</span> <span class="n">excess</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trimming </span><span class="si">%d</span><span class="s2">s excess time to make OFF-SOURCE duration a &quot;</span>
                     <span class="s2">&quot;multiple of </span><span class="si">%d</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">excess</span><span class="p">,</span> <span class="n">quanta</span><span class="p">))</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offsrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">offsrc</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="n">oncentre</span>
        <span class="k">if</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">excess</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">offsrc</span> <span class="o">&amp;=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">offsrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">excess</span><span class="p">,</span>
                                           <span class="n">offsrc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">offsrc</span> <span class="o">&amp;=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">offsrc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                           <span class="n">offsrc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">excess</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">offsrc</span><span class="p">)</span> <span class="o">%</span> <span class="n">quanta</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This will make OFF-SOURCE symmetrical about trigger &quot;</span>
                         <span class="s2">&quot;time.&quot;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offsrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">excess</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offsrc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">excess</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">offsrc</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">offsrc</span><span class="p">)</span> <span class="o">%</span> <span class="n">quanta</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Constructed OFF-SOURCE: duration </span><span class="si">%d</span><span class="s2">s (</span><span class="si">%d</span><span class="s2">s before to </span><span class="si">%d</span><span class="s2">s &quot;</span>
                 <span class="s2">&quot;after trigger).&quot;</span>
                 <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">offsrc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span><span class="p">,</span>
                    <span class="n">triggertime</span> <span class="o">-</span> <span class="n">offsrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">padding</span><span class="p">,</span>
                    <span class="n">offsrc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">triggertime</span> <span class="o">-</span> <span class="n">padding</span><span class="p">))</span>
    <span class="n">offsrc</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">([</span><span class="n">offsrc</span><span class="p">])</span>

    <span class="c1"># Put segments into segmentlistdicts</span>
    <span class="n">onsource</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>
    <span class="n">offsource</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>
    <span class="n">ifos</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">iifo</span> <span class="ow">in</span> <span class="n">sciencesegs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">ifos</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">iifo</span><span class="p">)</span>
        <span class="n">onsource</span><span class="p">[</span><span class="n">iifo</span><span class="p">]</span> <span class="o">=</span> <span class="n">onsrc</span>
        <span class="n">offsource</span><span class="p">[</span><span class="n">iifo</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsrc</span>

    <span class="k">return</span> <span class="n">onsource</span><span class="p">,</span> <span class="n">offsource</span></div>

<div class="viewcode-block" id="generate_triggered_segment"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.generate_triggered_segment">[docs]</a><span class="k">def</span> <span class="nf">generate_triggered_segment</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">sciencesegs</span><span class="p">):</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span>

    <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">,</span> <span class="s2">&quot;allow-single-ifo-search&quot;</span><span class="p">):</span>
        <span class="n">min_ifos</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_ifos</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">triggertime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow&#39;</span><span class="p">,</span> <span class="s1">&#39;trigger-time&#39;</span><span class="p">)))</span>
    <span class="n">minbefore</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;min-before&#39;</span><span class="p">)))</span>
    <span class="n">minafter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;min-after&#39;</span><span class="p">)))</span>
    <span class="n">minduration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;min-duration&#39;</span><span class="p">)))</span>
    <span class="n">onbefore</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;on-before&#39;</span><span class="p">)))</span>
    <span class="n">onafter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;on-after&#39;</span><span class="p">)))</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;pad-data&#39;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;workflow-condition_strain&quot;</span><span class="p">,</span> <span class="s2">&quot;do-gating&quot;</span><span class="p">):</span>
        <span class="n">padding</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;condition_strain&quot;</span><span class="p">,</span>
                                               <span class="s2">&quot;pad-data&quot;</span><span class="p">)))</span>

    <span class="c1"># How many IFOs meet minimum data requirements?</span>
    <span class="n">min_seg</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">triggertime</span> <span class="o">-</span> <span class="n">onbefore</span> <span class="o">-</span> <span class="n">minbefore</span> <span class="o">-</span> <span class="n">padding</span><span class="p">,</span>
                               <span class="n">triggertime</span> <span class="o">+</span> <span class="n">onafter</span> <span class="o">+</span> <span class="n">minafter</span> <span class="o">+</span> <span class="n">padding</span><span class="p">)</span>
    <span class="n">scisegs</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">({</span><span class="n">ifo</span><span class="p">:</span> <span class="n">sciencesegs</span><span class="p">[</span><span class="n">ifo</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">sciencesegs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">min_seg</span> <span class="ow">in</span> <span class="n">sciencesegs</span><span class="p">[</span><span class="n">ifo</span><span class="p">]</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sciencesegs</span><span class="p">[</span><span class="n">ifo</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">minduration</span><span class="p">})</span>

    <span class="c1"># Find highest number of IFOs that give an acceptable coherent segment</span>
    <span class="n">num_ifos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scisegs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">while</span> <span class="n">num_ifos</span> <span class="o">&gt;=</span> <span class="n">min_ifos</span><span class="p">:</span>
        <span class="c1"># Consider all combinations for a given number of IFOs</span>
        <span class="n">ifo_combos</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">scisegs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">num_ifos</span><span class="p">)</span>
        <span class="n">onsource</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">offsource</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ifo_combo</span> <span class="ow">in</span> <span class="n">ifo_combos</span><span class="p">:</span>
            <span class="n">ifos</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ifo_combo</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating optimal segment for </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">ifos</span><span class="p">)</span>
            <span class="n">segs</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">({</span><span class="n">ifo</span><span class="p">:</span> <span class="n">scisegs</span><span class="p">[</span><span class="n">ifo</span><span class="p">]</span>
                                             <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">ifo_combo</span><span class="p">})</span>
            <span class="n">onsource</span><span class="p">[</span><span class="n">ifos</span><span class="p">],</span> <span class="n">offsource</span><span class="p">[</span><span class="n">ifos</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_triggered_coherent_segment</span><span class="p">(</span>\
                    <span class="n">workflow</span><span class="p">,</span> <span class="n">segs</span><span class="p">)</span>

        <span class="c1"># Which combination gives the longest coherent segment?</span>
        <span class="n">valid_combs</span> <span class="o">=</span> <span class="p">[</span><span class="n">iifos</span> <span class="k">for</span> <span class="n">iifos</span> <span class="ow">in</span> <span class="n">onsource</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                       <span class="k">if</span> <span class="n">onsource</span><span class="p">[</span><span class="n">iifos</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_combs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If none, offsource dict will contain segments showing criteria</span>
            <span class="c1"># that have not been met, for use in plotting</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsource</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">seg_lens</span> <span class="o">=</span> <span class="p">{</span><span class="n">ifos</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">offsource</span><span class="p">[</span><span class="n">ifos</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">ifos</span> <span class="ow">in</span> <span class="n">offsource</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
                <span class="n">best_comb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">seg_lens</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(),</span>
                                <span class="n">key</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="n">seg_lens</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">best_comb</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">offsource</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No combination of </span><span class="si">%d</span><span class="s2"> IFOs with suitable science &quot;</span>
                         <span class="s2">&quot;segment.&quot;</span><span class="p">,</span> <span class="n">num_ifos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Identify best analysis segment</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_combs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">seg_lens</span> <span class="o">=</span> <span class="p">{</span><span class="n">ifos</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">offsource</span><span class="p">[</span><span class="n">ifos</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">ifos</span> <span class="ow">in</span> <span class="n">valid_combs</span><span class="p">}</span>
                <span class="n">best_comb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">seg_lens</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(),</span>
                                <span class="n">key</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="n">seg_lens</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">best_comb</span> <span class="o">=</span> <span class="n">valid_combs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculated science segments.&quot;</span><span class="p">)</span>

            <span class="n">offsourceSegfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;offSourceSeg.txt&quot;</span><span class="p">)</span>
            <span class="n">segmentsUtils</span><span class="o">.</span><span class="n">tosegwizard</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">offsourceSegfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span>
                                      <span class="nb">list</span><span class="p">(</span><span class="n">offsource</span><span class="p">[</span><span class="n">best_comb</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">onsourceSegfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;onSourceSeg.txt&quot;</span><span class="p">)</span>
            <span class="n">segmentsUtils</span><span class="o">.</span><span class="n">tosegwizard</span><span class="p">(</span><span class="n">file</span><span class="p">(</span><span class="n">onsourceSegfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span>
                                      <span class="nb">list</span><span class="p">(</span><span class="n">onsource</span><span class="p">[</span><span class="n">best_comb</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">bufferleft</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;num-buffer-before&#39;</span><span class="p">))</span>
            <span class="n">bufferright</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workflow-exttrig_segments&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;num-buffer-after&#39;</span><span class="p">))</span>
            <span class="n">onlen</span> <span class="o">=</span> <span class="n">onbefore</span> <span class="o">+</span> <span class="n">onafter</span>
            <span class="n">bufferSegment</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span>\
                    <span class="n">triggertime</span> <span class="o">-</span> <span class="n">onbefore</span> <span class="o">-</span> <span class="n">bufferleft</span> <span class="o">*</span> <span class="n">onlen</span><span class="p">,</span>
                    <span class="n">triggertime</span> <span class="o">+</span> <span class="n">onafter</span> <span class="o">+</span> <span class="n">bufferright</span> <span class="o">*</span> <span class="n">onlen</span><span class="p">)</span>
            <span class="n">bufferSegfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;bufferSeg.txt&quot;</span><span class="p">)</span>
            <span class="n">segmentsUtils</span><span class="o">.</span><span class="n">tosegwizard</span><span class="p">(</span><span class="n">file</span><span class="p">(</span><span class="n">bufferSegfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span>
                                      <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">([</span><span class="n">bufferSegment</span><span class="p">]))</span>

            <span class="k">return</span> <span class="n">onsource</span><span class="p">[</span><span class="n">best_comb</span><span class="p">],</span> <span class="n">offsource</span><span class="p">[</span><span class="n">best_comb</span><span class="p">]</span>

        <span class="n">num_ifos</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No suitable science segments available.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">offsource</span><span class="p">[</span><span class="n">best_comb</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">UnboundLocalError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_seg</span></div>

<div class="viewcode-block" id="save_veto_definer"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.save_veto_definer">[docs]</a><span class="k">def</span> <span class="nf">save_veto_definer</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Retrieve the veto definer file and save it locally</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    cp : ConfigParser instance</span>
<span class="sd">    out_dir : path</span>
<span class="sd">    tags : list of strings</span>
<span class="sd">        Used to retrieve subsections of the ini file for</span>
<span class="sd">        configuration options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">make_analysis_dir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="n">veto_def_url</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;segments-veto-definer-url&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
    <span class="n">veto_def_base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">veto_def_url</span><span class="p">)</span>
    <span class="n">veto_def_new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span>
                                        <span class="n">veto_def_base_name</span><span class="p">))</span>
    <span class="c1"># Don&#39;t need to do this if already done</span>
    <span class="n">resolve_url</span><span class="p">(</span><span class="n">veto_def_url</span><span class="p">,</span><span class="n">out_dir</span><span class="p">)</span>

    <span class="c1"># and update location</span>
    <span class="n">cp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span> <span class="s2">&quot;segments-veto-definer-file&quot;</span><span class="p">,</span> <span class="n">veto_def_new_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">veto_def_new_path</span></div>

<div class="viewcode-block" id="parse_cat_ini_opt"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.parse_cat_ini_opt">[docs]</a><span class="k">def</span> <span class="nf">parse_cat_ini_opt</span><span class="p">(</span><span class="n">cat_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parse a cat str from the ini file into a list of sets &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cat_str</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">cat_groups</span> <span class="o">=</span> <span class="n">cat_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">cat_sets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">cat_groups</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">cat_sets</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">group</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">cat_sets</span></div>

<div class="viewcode-block" id="cat_to_veto_def_cat"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.cat_to_veto_def_cat">[docs]</a><span class="k">def</span> <span class="nf">cat_to_veto_def_cat</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert a category character to the corresponding value in the veto</span>
<span class="sd">    definer file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    str : single character string</span>
<span class="sd">        The input category character</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pipedown_str : str</span>
<span class="sd">        The pipedown equivalent notation that can be passed to programs</span>
<span class="sd">    that expect this definition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid Category Choice&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="file_needs_generating"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.file_needs_generating">[docs]</a><span class="k">def</span> <span class="nf">file_needs_generating</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This job tests the file location and determines if the file should be</span>
<span class="sd">    generated now or if an error should be raised. This uses the</span>
<span class="sd">    generate_segment_files variable, global to this module, which is described</span>
<span class="sd">    above and in the documentation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    file_path : path</span>
<span class="sd">        Location of file to check</span>
<span class="sd">    cp : ConfigParser</span>
<span class="sd">        The associated ConfigParser from which the</span>
<span class="sd">        segments-generate-segment-files variable is returned.</span>
<span class="sd">        It is recommended for most applications to use the default option by</span>
<span class="sd">        leaving segments-generate-segment-files blank, which will regenerate</span>
<span class="sd">        all segment files at runtime. Only use this facility if you need it.</span>
<span class="sd">        Choices are</span>
<span class="sd">        * &#39;always&#39; : DEFAULT: All files will be generated even if they already exist.</span>
<span class="sd">        * &#39;if_not_present&#39;: Files will be generated if they do not already exist. Pre-existing files will be read in and used.</span>
<span class="sd">        * &#39;error_on_duplicate&#39;: Files will be generated if they do not already exist. Pre-existing files will raise a failure.</span>
<span class="sd">        * &#39;never&#39;: Pre-existing files will be read in and used. If no file exists the code will fail.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    int</span>
<span class="sd">        1 = Generate the file. 0 = File already exists, use it. Other cases</span>
<span class="sd">        will raise an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;segments-generate-segment-files&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;segments-generate-segment-files&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
        <span class="n">generate_segment_files</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">generate_segment_files</span> <span class="o">=</span> <span class="s1">&#39;always&#39;</span>

    <span class="c1"># Does the file exist</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">generate_segment_files</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;if_not_present&#39;</span><span class="p">,</span> <span class="s1">&#39;never&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">generate_segment_files</span> <span class="o">==</span> <span class="s1">&#39;always&#39;</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> already exists. &quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">file_path</span><span class="p">,)</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;Regenerating and overwriting.&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">generate_segment_files</span> <span class="o">==</span> <span class="s1">&#39;error_on_duplicate&#39;</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> already exists. &quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">file_path</span><span class="p">,)</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;Refusing to overwrite file and exiting.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;Global variable generate_segment_files must be one of &#39;</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s1">&#39;&quot;always&quot;, &quot;if_not_present&quot;, &quot;error_on_duplicate&quot;, &#39;</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s1">&#39;&quot;never&quot;. Got </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">generate_segment_files</span><span class="p">,)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">generate_segment_files</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="s1">&#39;if_not_present&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;error_on_duplicate&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">generate_segment_files</span> <span class="o">==</span> <span class="s1">&#39;never&#39;</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> does not exist. &#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">file_path</span><span class="p">,)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;Global variable generate_segment_files must be one of &#39;</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s1">&#39;&quot;always&quot;, &quot;if_not_present&quot;, &quot;error_on_duplicate&quot;, &#39;</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s1">&#39;&quot;never&quot;. Got </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">generate_segment_files</span><span class="p">,)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_segments_file"><a class="viewcode-back" href="../../../workflow/segments.html#pycbc.workflow.segment.get_segments_file">[docs]</a><span class="k">def</span> <span class="nf">get_segments_file</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">option_name</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get cumulative segments from option name syntax for each ifo.</span>

<span class="sd">    Use syntax of configparser string to define the resulting segment_file</span>
<span class="sd">    e.x. option_name = +up_flag1,+up_flag2,+up_flag3,-down_flag1,-down_flag2</span>
<span class="sd">    Each ifo may have a different string and is stored separately in the file.</span>
<span class="sd">    Flags which add time must precede flags which subtract time.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    workflow: pycbc.workflow.Workflow</span>
<span class="sd">    name: string</span>
<span class="sd">        Name of the segment list being created</span>
<span class="sd">    option_name: str</span>
<span class="sd">        Name of option in the associated config parser to get the flag list</span>

<span class="sd">    returns</span>
<span class="sd">    --------</span>
<span class="sd">    seg_file: pycbc.workflow.SegFile</span>
<span class="sd">        SegFile intance that points to the segment xml file on disk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pycbc.dq</span> <span class="kn">import</span> <span class="n">query_str</span>
    <span class="n">make_analysis_dir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">cp</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Check for veto definer file</span>
    <span class="n">veto_definer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span> <span class="s2">&quot;segments-veto-definer-url&quot;</span><span class="p">):</span>
        <span class="n">veto_definer</span> <span class="o">=</span> <span class="n">save_veto_definer</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># Check for provided server</span>
    <span class="n">server</span> <span class="o">=</span> <span class="s2">&quot;https://segments.ligo.org&quot;</span>
    <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span> <span class="s2">&quot;segments-database-url&quot;</span><span class="p">):</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;segments-database-url&quot;</span><span class="p">)</span>

    <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;any&quot;</span>
    <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span> <span class="s2">&quot;segments-source&quot;</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span> <span class="s2">&quot;segments-source&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
        <span class="n">local_file_path</span> <span class="o">=</span> \
            <span class="n">resolve_url</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span> <span class="n">option_name</span><span class="o">+</span><span class="s2">&quot;-file&quot;</span><span class="p">))</span>
        <span class="n">pfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">pfn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SegFile</span><span class="o">.</span><span class="n">from_segment_xml</span><span class="p">(</span><span class="n">pfn</span><span class="p">)</span>

    <span class="n">segs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">ifos</span><span class="p">:</span>
        <span class="n">flag_str</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s2">&quot;workflow-segments&quot;</span><span class="p">,</span> <span class="n">option_name</span><span class="p">,</span> <span class="p">[</span><span class="n">ifo</span><span class="p">])</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">segs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_str</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span> <span class="n">flag_str</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span>
                              <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span>
                              <span class="n">veto_definer</span><span class="o">=</span><span class="n">veto_definer</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: got </span><span class="si">%s</span><span class="s2"> flags&quot;</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span> <span class="n">option_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SegFile</span><span class="o">.</span><span class="n">from_segment_list_dict</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">segs</span><span class="p">,</span>
                                          <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;.xml&#39;</span><span class="p">,</span>
                                          <span class="n">valid_segment</span><span class="o">=</span><span class="n">workflow</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">,</span>
                                          <span class="n">directory</span><span class="o">=</span><span class="n">out_dir</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015, 2016, 2017, Alexander Nitz, Ian Harry, Christopher M. Biwer, Duncan A.  Brown, Josh Willis, and Tito Dal Canton.
      <span class="lastupdated">Last updated on Oct 20, 2021.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>