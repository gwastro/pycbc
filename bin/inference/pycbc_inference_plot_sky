#! /usr/bin/env python

import argparse
import sys
import subprocess
from PIL import Image, PngImagePlugin


parser = argparse.ArgumentParser()
parser.add_argument('--input-file', required=True,
                    help='input fits file"')
parser.add_argument('--output-file', required=True,
                    help='must end in ".fits"')
parser.add_argument('--colormap')

opts = parser.parse_args()

cmd = 'ligo-skymap-plot {} -o {} --annotate --contour 50 90'.format(
    opts.input_file, opts.output_file)
if opts.colormap is not None:
    cmd += ' --colormap {}'.format(opts.colormap)
ret = subprocess.run(cmd.split())
ret.check_returncode()

im = Image.open(opts.output_file)
meta = PngImagePlugin.PngInfo()

kwds = {'cmd': " ".join(sys.argv),
        'title': "Sky map",
        'caption': "Sky location posterior probability."}
for key in kwds:
    meta.add_text(str(key), str(kwds[key]))
im.save(opts.output_file, "png", pnginfo=meta)
