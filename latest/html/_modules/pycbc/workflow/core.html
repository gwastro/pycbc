

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pycbc.workflow.core &mdash; PyCBC 2.10.dev1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=751f435e"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/typed.min.js?v=edb71f0b"></script>
      <script src="../../../_static/terminal.css?v=d691274a"></script>
      <script src="../../../_static/theme_overrides.css?v=e4e1d026"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: linear-gradient(0deg, rgba(0,0,0,1) 0%, rgba(193,193,255,1) 85%)" >

          
          
          <a href="../../../index.html">
            
              <img src="https://raw.githubusercontent.com/gwastro/pycbc-logo/master/pycbc_logo_name.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installing PyCBC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credit.html">Use of PyCBC in Scientific Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Library Examples and Interactive Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../searches.html">PyCBC searches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../inference.html">PyCBC inference documentation (<code class="docutils literal notranslate"><span class="pre">pycbc.inference</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apps.html">Applications and Workflows</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Dev Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../extend.html">Extending PyCBC with external plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devs.html">Documentation for Developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: linear-gradient(0deg, rgba(0,0,0,1) 0%, rgba(193,193,255,1) 85%)" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyCBC</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../pycbc.html">pycbc</a></li>
      <li class="breadcrumb-item active">pycbc.workflow.core</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pycbc.workflow.core</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (C) 2013, 2017  Ian Harry, Alex Nitz, Duncan Brown</span>
<span class="c1">#</span>
<span class="c1"># This program is free software; you can redistribute it and/or modify it</span>
<span class="c1"># under the terms of the GNU General Public License as published by the</span>
<span class="c1"># Free Software Foundation; either version 3 of the License, or (at your</span>
<span class="c1"># option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful, but</span>
<span class="c1"># WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General</span>
<span class="c1"># Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License along</span>
<span class="c1"># with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="c1"># 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>

<span class="c1">#</span>
<span class="c1"># =============================================================================</span>
<span class="c1">#</span>
<span class="c1">#                                   Preamble</span>
<span class="c1">#</span>
<span class="c1"># =============================================================================</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module provides the worker functions and classes that are used when</span>
<span class="sd">creating a workflow. For details about the workflow module see here:</span>
<span class="sd">https://ldas-jobs.ligo.caltech.edu/~cbc/docs/pycbc/ahope.html</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">stat</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">configparser</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ConfigParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.request</span><span class="w"> </span><span class="kn">import</span> <span class="n">pathname2url</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urljoin</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">permutations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">operator</span><span class="w"> </span><span class="kn">import</span> <span class="n">attrgetter</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">igwn_segments</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">segments</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lal.utils</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">Pegasus.api</span>  <span class="c1"># Try and move this into pegasus_workflow</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">igwn_ligolw</span><span class="w"> </span><span class="kn">import</span> <span class="n">lsctables</span><span class="p">,</span> <span class="n">ligolw</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">igwn_ligolw</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">ligolw_utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">igwn_ligolw.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">segments</span> <span class="k">as</span> <span class="n">ligolw_segments</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pycbc</span><span class="w"> </span><span class="kn">import</span> <span class="n">makedir</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pycbc.io.ligolw</span><span class="w"> </span><span class="kn">import</span> <span class="n">LIGOLWContentHandler</span><span class="p">,</span> <span class="n">create_process_table</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">pegasus_workflow</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.configuration</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkflowConfigParser</span><span class="p">,</span> <span class="n">resolve_url</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.pegasus_sites</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_catalog</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pycbc.workflow.core&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="make_analysis_dir">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.make_analysis_dir">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_analysis_dir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make the analysis directory path, any parent directories that don&#39;t already</span>
<span class="sd">    exist, and the &#39;logs&#39; subdirectory of path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">makedir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">))</span></div>



<span class="n">file_input_from_config_dict</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Executable">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Executable">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Executable</span><span class="p">(</span><span class="n">pegasus_workflow</span><span class="o">.</span><span class="n">Executable</span><span class="p">):</span>
    <span class="c1"># These are the file retention levels</span>
    <span class="n">DO_NOT_KEEP</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">INTERMEDIATE_PRODUCT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ALL_TRIGGERS</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">MERGED_TRIGGERS</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">FINAL_RESULT</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c1"># Set this parameter to indicate that this option is used to specify a</span>
    <span class="c1"># file and is *not* handled explicitly in the create_node or __init__</span>
    <span class="c1"># methods of the sub-class. Usually that is to say that this option is a</span>
    <span class="c1"># file and is normally specified in an file, e.g. a PSD file. As files</span>
    <span class="c1"># need to be identified as such to pegasus, this attempts to catch this</span>
    <span class="c1"># case.</span>
    <span class="c1"># These are standard file input arguments used in PyCBC, so we declare</span>
    <span class="c1"># these as files if given to any PyCBC job.</span>
    <span class="n">file_input_options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--gating-file&#39;</span><span class="p">,</span> <span class="s1">&#39;--frame-files&#39;</span><span class="p">,</span> <span class="s1">&#39;--injection-file&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;--statistic-files&#39;</span><span class="p">,</span> <span class="s1">&#39;--bank-file&#39;</span><span class="p">,</span> <span class="s1">&#39;--config-files&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;--psd-file&#39;</span><span class="p">,</span> <span class="s1">&#39;--asd-file&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;--fake-strain-from-file&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;--sgburst-injection-file&#39;</span><span class="p">]</span>

    <span class="c1"># Set this parameter to indicate that this option should take different</span>
    <span class="c1"># values based on the time. E.g. something like</span>
    <span class="c1"># --option1 value1[0:1000],value2[1000:2000]</span>
    <span class="c1"># would be replaced with --option1 value1 if the time is within 0,1000 and</span>
    <span class="c1"># value2 if in 1000,2000. A failure will be replaced if the job time is</span>
    <span class="c1"># not fully contained in one of these windows, or if fully contained in</span>
    <span class="c1"># multiple of these windows. This is resolved when creating the Job from</span>
    <span class="c1"># the Executable</span>
    <span class="n">time_dependent_options</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># This is the default value. It will give a warning if a class is</span>
    <span class="c1"># used where the retention level is not set. The file will still be stored</span>
    <span class="n">KEEP_BUT_RAISE_WARNING</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">_warned_classes_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Executable&#39;</span><span class="p">]</span>

    <span class="c1"># Sub classes, or instances, should override this. If not overriden the</span>
    <span class="c1"># file will be retained, but a warning given</span>
    <span class="n">current_retention_level</span> <span class="o">=</span> <span class="n">KEEP_BUT_RAISE_WARNING</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ifos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">reuse_executable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">set_submit_subdir</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Executable class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        cp : ConfigParser object</span>
<span class="sd">            The ConfigParser object holding the workflow configuration settings</span>
<span class="sd">        name : string</span>
<span class="sd">            Executable name</span>
<span class="sd">        ifos : string or list, optional</span>
<span class="sd">            The ifo(s) that the Job is valid for. If the job is</span>
<span class="sd">            independently valid for multiple ifos it can be provided as a list.</span>
<span class="sd">            Ie. [&#39;H1&#39;,L1&#39;,&#39;V1&#39;], if the job is only valid for the combination</span>
<span class="sd">            of ifos (for e.g. ligolw_thinca) then this can be supplied</span>
<span class="sd">            as, for e.g. &quot;H1L1V1&quot;.</span>
<span class="sd">        out_dir: path, optional</span>
<span class="sd">            The folder to store output files of this job.</span>
<span class="sd">        tags : list of strings</span>
<span class="sd">            A list of strings that is used to identify this job.</span>
<span class="sd">        reuse_executable: boolean [default True]</span>
<span class="sd">            If True, Pegasus simply uses the name of the (executable) script</span>
<span class="sd">            to label the Executable instance, otherwise it also includes tags</span>
<span class="sd">            in the labeling and, e.g., performance information is recorded</span>
<span class="sd">            individually by job rather than being grouped together on the</span>
<span class="sd">            basis of the script name.</span>
<span class="sd">        set_submit_subdir: boolean [default True]</span>
<span class="sd">            Place condor files associated with this executable under a</span>
<span class="sd">            sub-directory (named according to the executable name) in the</span>
<span class="sd">            submitdir.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ifos</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ifos</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span> <span class="o">=</span> <span class="n">ifos</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cp</span> <span class="o">=</span> <span class="n">cp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container_cls</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container_type</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">installed</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;pegasus_profile-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                                           <span class="s1">&#39;pycbc|installed&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">installed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_current_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_output_directory</span><span class="p">(</span><span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">)</span>

        <span class="c1"># Determine the level at which output files should be kept</span>
        <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option_tags</span><span class="p">(</span><span class="s1">&#39;pegasus_profile-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                              <span class="s1">&#39;pycbc|retention_level&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
            <span class="c1"># Get the retention_level from the config file</span>
            <span class="c1"># This method allows us to use the retention levels</span>
            <span class="c1"># defined above</span>
            <span class="n">cfg_ret_level</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s1">&#39;pegasus_profile-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;pycbc|retention_level&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_retention_level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg_ret_level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_current_retention_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_retention_level</span><span class="p">)</span>

        <span class="c1"># Should I reuse this executable?</span>
        <span class="k">if</span> <span class="n">reuse_executable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pegasus_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pegasus_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagged_name</span>

        <span class="c1"># Check that the executable actually exists locally or</span>
        <span class="c1"># looks like a URL, in which case trust Pegasus to be</span>
        <span class="c1"># able to fetch it.</span>
        <span class="n">exe_path</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;executables&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needs_fetching</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">exe_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">exe_path</span><span class="p">)</span>

        <span class="c1"># See if the user specified a list of sites for the executable</span>
        <span class="c1"># Ordering is:</span>
        <span class="c1">#  1) Check if a specific site for this Executable is set.</span>
        <span class="c1">#  2) Check is primary_site is set globally.</span>
        <span class="c1">#  3) Use condorpool_symlink as a fallback.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exe_pfns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option_tags</span><span class="p">(</span><span class="s1">&#39;pegasus_profile-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;pycbc|site&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
            <span class="n">exe_site</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s1">&#39;pegasus_profile-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                                       <span class="s1">&#39;pycbc|site&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;pegasus_profile&#39;</span><span class="p">,</span> <span class="s1">&#39;pycbc|primary_site&#39;</span><span class="p">):</span>
            <span class="n">exe_site</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pegasus_profile&#39;</span><span class="p">,</span> <span class="s1">&#39;pycbc|primary_site&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exe_site</span> <span class="o">=</span> <span class="s1">&#39;condorpool_symlink&#39;</span>

        <span class="n">exe_site</span> <span class="o">=</span> <span class="n">exe_site</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">exe_url</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">]:</span>
            <span class="c1"># NOTE: There could be a case where the exe is available at a</span>
            <span class="c1">#       remote site, but not on the submit host. Currently allowed</span>
            <span class="c1">#       for the OSG site, versioning will not work as planned if</span>
            <span class="c1">#       we can&#39;t see the executable (can we perhaps run versioning</span>
            <span class="c1">#       including singularity??)</span>

            <span class="c1"># Check that executables at file urls</span>
            <span class="c1">#  on the local site exist</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">exe_url</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Failed to find </span><span class="si">%s</span><span class="s2"> executable &quot;</span>
                                <span class="s2">&quot;at </span><span class="si">%s</span><span class="s2"> on site </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">exe_path</span><span class="p">,</span>
                                <span class="n">exe_site</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">exe_url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;singularity&#39;</span><span class="p">:</span>
            <span class="c1"># Will use an executable within a singularity container. Don&#39;t</span>
            <span class="c1"># need to do anything here, as I cannot easily check it exists.</span>
            <span class="n">exe_path</span> <span class="o">=</span> <span class="n">exe_url</span><span class="o">.</span><span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Could be http, https, etc. so it needs fetching if run now</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">needs_fetching</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_fetching</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Non-file path URLs cannot be used unless the &quot;</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;executable is a bundled standalone executable. &quot;</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;If this is the case, then add the &quot;</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;pycbc.installed=True property.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
            <span class="c1"># Is installed, so copy from local site, like other inputs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exe_pfns</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exe_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We must rely on the executables, and accompanying libraries,</span>
            <span class="c1"># being directly accessible on the execution site.</span>
            <span class="c1"># CVMFS is perfect for this! As is singularity.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exe_pfns</span><span class="p">[</span><span class="n">exe_site</span><span class="p">]</span> <span class="o">=</span> <span class="n">exe_path</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Using </span><span class="si">%s</span><span class="s2"> executable at </span><span class="si">%s</span><span class="s2"> on site </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">exe_url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="n">exe_site</span>
        <span class="p">)</span>

        <span class="c1"># FIXME: This hasn&#39;t yet been ported to pegasus5 and won&#39;t work.</span>
        <span class="c1">#        Pegasus describes two ways to work with containers, and I need</span>
        <span class="c1">#        to figure out which is most appropriate and use that.</span>
        <span class="c1"># Determine if this executables should be run in a container</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container_type</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pegasus_profile-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                                         <span class="s1">&#39;container|type&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">container_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># FIXME: Move the actual container setup into pegasus_workflow</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container_img</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pegasus_profile-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                                        <span class="s1">&#39;container|image&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">container_site</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pegasus_profile-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                                             <span class="s1">&#39;container|image_site&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">container_site</span> <span class="o">=</span> <span class="s1">&#39;local&#39;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">container_mount</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pegasus_profile-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                                             <span class="s1">&#39;container|mount&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">container_mount</span> <span class="o">=</span> <span class="kc">None</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">container_cls</span> <span class="o">=</span> <span class="n">Pegasus</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Container</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-container&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="n">name</span><span class="p">),</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">container_type</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">container_img</span><span class="p">,</span>
                                                    <span class="n">imagesite</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container_site</span><span class="p">,</span>
                                                    <span class="n">mount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container_mount</span><span class="p">)</span>

            <span class="nb">super</span><span class="p">(</span><span class="n">Executable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pegasus_name</span><span class="p">,</span>
                                             <span class="n">installed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">,</span>
                                             <span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container_cls</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Executable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pegasus_name</span><span class="p">,</span>
                                             <span class="n">installed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">installed</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;group_jobs&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_profile</span><span class="p">(</span><span class="s1">&#39;pegasus&#39;</span><span class="p">,</span> <span class="s1">&#39;clusters.size&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_jobs</span><span class="p">)</span>

        <span class="c1"># This sets up the sub-directory to use in the submit directory</span>
        <span class="k">if</span> <span class="n">set_submit_subdir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_profile</span><span class="p">(</span><span class="s1">&#39;pegasus&#39;</span><span class="p">,</span> <span class="s1">&#39;relative.submit.dir&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">pegasus_name</span><span class="p">)</span>

        <span class="c1"># Set configurations from the config file, these should override all</span>
        <span class="c1"># other settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_pegasus_profile_options</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">execution_site</span> <span class="o">=</span> <span class="n">exe_site</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable_url</span> <span class="o">=</span> <span class="n">exe_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ifo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the ifo.</span>

<span class="sd">        If only one ifo in the ifo list this will be that ifo. Otherwise an</span>
<span class="sd">        error is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errMsg</span> <span class="o">=</span> <span class="s2">&quot;self.ifoList must contain only one ifo to access the &quot;</span>
            <span class="n">errMsg</span> <span class="o">+=</span> <span class="s2">&quot;ifo property. </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">),)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">errMsg</span><span class="p">)</span>

<div class="viewcode-block" id="Executable.get_transformation">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Executable.get_transformation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_site</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_transformation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_site</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">executable_url</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transformation</span><span class="p">()</span></div>


<div class="viewcode-block" id="Executable.add_ini_profile">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Executable.add_ini_profile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_ini_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">sec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add profile from configuration file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        cp : ConfigParser object</span>
<span class="sd">            The ConfigParser object holding the workflow configuration settings</span>
<span class="sd">        sec : string</span>
<span class="sd">            The section containing options for this job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">cp</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">sec</span><span class="p">):</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">namespace</span> <span class="o">==</span> <span class="s1">&#39;pycbc&#39;</span> <span class="ow">or</span> <span class="n">namespace</span> <span class="o">==</span> <span class="s1">&#39;container&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_profile</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_add_ini_opts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">ignore_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add job-specific options from configuration file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        cp : ConfigParser object</span>
<span class="sd">            The ConfigParser object holding the workflow configuration</span>
<span class="sd">            settings</span>
<span class="sd">        sec : string</span>
<span class="sd">            The section containing options for this job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">cp</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">sec</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_added_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ignore_existing</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Option </span><span class="si">%s</span><span class="s2"> has already been added&quot;</span> <span class="o">%</span> <span class="n">opt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_added_options</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;--</span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_input_options</span><span class="p">:</span>
                <span class="c1"># This now expects the option to be a file</span>
                <span class="c1"># Check if we have a list of files</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">common_raw_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">common_raw_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

                <span class="c1"># Get LFN and PFN</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="c1"># Here I decide if the path is URL or</span>
                    <span class="c1"># IFO:/path/to/file or IFO:url://path/to/file</span>
                    <span class="c1"># That&#39;s somewhat tricksy as we used : as delimiter</span>
                    <span class="n">split_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ifo</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Have I split a URL or not?</span>
                        <span class="k">if</span> <span class="n">split_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">):</span>
                            <span class="c1"># URL</span>
                            <span class="n">ifo</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1">#IFO:path or IFO:URL</span>
                            <span class="n">ifo</span> <span class="o">=</span> <span class="n">split_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">split_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1"># If the file exists make sure to use the</span>
                    <span class="c1"># fill path as a file:// URL</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                        <span class="n">curr_pfn</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="s1">&#39;file:&#39;</span><span class="p">,</span>
                                           <span class="n">pathname2url</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">curr_pfn</span> <span class="o">=</span> <span class="n">path</span>

                    <span class="n">curr_file</span> <span class="o">=</span> <span class="n">resolve_url_to_file</span><span class="p">(</span><span class="n">curr_pfn</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">common_input_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ifo</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">common_raw_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">common_raw_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_file</span><span class="o">.</span><span class="n">dax_repr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">common_raw_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_file</span><span class="o">.</span><span class="n">dax_repr</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">common_raw_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_dependent_options</span><span class="p">:</span>
                <span class="c1"># There is a possibility of time-dependent, file options.</span>
                <span class="c1"># For now we will avoid supporting that complication unless</span>
                <span class="c1"># it is needed. This would require resolving the file first</span>
                <span class="c1"># in this function, and then dealing with the time-dependent</span>
                <span class="c1"># stuff later.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unresolved_td_options</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This option comes from the config file(s)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">common_options</span> <span class="o">+=</span> <span class="p">[</span><span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>

<div class="viewcode-block" id="Executable.add_opt">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Executable.add_opt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add option to job.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        opt : string</span>
<span class="sd">            Name of option (e.g. --output-file-format)</span>
<span class="sd">        value : string, (default=None)</span>
<span class="sd">            The value for the option (no value if set to None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">common_options</span> <span class="o">+=</span> <span class="p">[</span><span class="n">opt</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">common_options</span> <span class="o">+=</span> <span class="p">[</span><span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span></div>


<div class="viewcode-block" id="Executable.get_opt">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Executable.get_opt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get value of option from configuration file</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        opt : string</span>
<span class="sd">            Name of option (e.g. output-file-format)</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        value : string</span>
<span class="sd">            The value for the option. Returns None if option not present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">key</span>
            <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Executable.has_opt">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Executable.has_opt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if option is present in configuration file</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        opt : string</span>
<span class="sd">            Name of option (e.g. output-file-format)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">val</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Executable.create_node">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Executable.create_node">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default node constructor.</span>

<span class="sd">        This is usually overridden by subclasses of Executable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Executable.update_current_retention_level">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Executable.update_current_retention_level">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_current_retention_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a new value for the current retention level.</span>

<span class="sd">        This updates the value of self.retain_files for an updated value of the</span>
<span class="sd">        retention level.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        value : int</span>
<span class="sd">            The new value to use for the retention level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the level at which output files should be kept</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_retention_level</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">global_retention_level</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">get_opt_tags</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">,</span> <span class="s2">&quot;file-retention-level&quot;</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Cannot find file-retention-level in [workflow] section &quot;</span>
            <span class="n">msg</span><span class="o">+=</span><span class="s2">&quot;of the configuration file. Setting a default value of &quot;</span>
            <span class="n">msg</span><span class="o">+=</span><span class="s2">&quot;retain all files.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retain_files</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_retention_threshold</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">,</span> <span class="s2">&quot;file-retention-level&quot;</span><span class="p">,</span> <span class="s2">&quot;all_files&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># FIXME: Are these names suitably descriptive?</span>
            <span class="n">retention_choices</span> <span class="o">=</span> <span class="p">{</span>
                                 <span class="s1">&#39;all_files&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="s1">&#39;all_triggers&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                 <span class="s1">&#39;merged_triggers&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                 <span class="s1">&#39;results&#39;</span> <span class="p">:</span> <span class="mi">4</span>
                                <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_retention_threshold</span> <span class="o">=</span> \
                      <span class="n">retention_choices</span><span class="p">[</span><span class="n">global_retention_level</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot recognize the file-retention-level in the &quot;</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;[workflow] section of the ini file. &quot;</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;Got : </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">global_retention_level</span><span class="p">)</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;Valid options are: &#39;all_files&#39;, &#39;all_triggers&#39;,&quot;</span>
                <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;&#39;merged_triggers&#39; or &#39;results&#39; &quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_retention_level</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retain_files</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="n">Executable</span><span class="o">.</span><span class="n">_warned_classes_list</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warn_msg</span> <span class="o">=</span> <span class="s2">&quot;Attribute current_retention_level has not &quot;</span>
                    <span class="n">warn_msg</span> <span class="o">+=</span> <span class="s2">&quot;been set in class </span><span class="si">{0}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                    <span class="n">warn_msg</span> <span class="o">+=</span> <span class="s2">&quot;This value should be set explicitly. &quot;</span>
                    <span class="n">warn_msg</span> <span class="o">+=</span> <span class="s2">&quot;All output from this class will be stored.&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>
                    <span class="n">Executable</span><span class="o">.</span><span class="n">_warned_classes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_retention_threshold</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_retention_level</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retain_files</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retain_files</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Executable.update_current_tags">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Executable.update_current_tags">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_current_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a new set of tags for this executable.</span>

<span class="sd">        Update the set of tags that this job will use. This updated default</span>
<span class="sd">        file naming and shared options. It will *not* update the pegasus</span>
<span class="sd">        profile, which belong to the executable and cannot be different for</span>
<span class="sd">        different nodes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        tags : list</span>
<span class="sd">            The new list of tags to consider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;DO NOT GIVE ME EMPTY TAGS (in </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">warn_msg</span> <span class="o">=</span> <span class="s2">&quot;This job has way too many tags. &quot;</span>
            <span class="n">warn_msg</span> <span class="o">+=</span> <span class="s2">&quot;Current tags are </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span>
            <span class="n">warn_msg</span> <span class="o">+=</span> <span class="s2">&quot;Current executable </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tagged_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">-</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tagged_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tagged_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">-</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagged_name</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span><span class="p">)</span>

        <span class="c1"># Determine the sections from the ini file that will configure</span>
        <span class="c1"># this executable</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sec_tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sec_tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sec_tags</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="k">for</span> <span class="n">sec_len</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sec_tags</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">tag_permutation</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">(</span><span class="n">sec_tags</span><span class="p">,</span> <span class="n">sec_len</span><span class="p">):</span>
                <span class="n">joined_name</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tag_permutation</span><span class="p">)</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">joined_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
                    <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="n">sections</span>

        <span class="c1"># Do some basic sanity checking on the options</span>
        <span class="k">for</span> <span class="n">sec1</span><span class="p">,</span> <span class="n">sec2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">sections</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">check_duplicate_options</span><span class="p">(</span><span class="n">sec1</span><span class="p">,</span> <span class="n">sec2</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># collect the options and profile information</span>
        <span class="c1"># from the ini file section(s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_added_options</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">common_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">common_raw_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unresolved_td_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">common_input_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">sec</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_ini_opts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="n">sec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warn_string</span> <span class="o">=</span> <span class="s2">&quot;warning: config file is missing section &quot;</span>
                <span class="n">warn_string</span> <span class="o">+=</span> <span class="s2">&quot;[</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warn_string</span><span class="p">)</span>

        <span class="c1"># get uppermost section</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-defaultvalues&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_ini_opts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-defaultvalues&#39;</span><span class="p">,</span>
                               <span class="n">ignore_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Executable.update_output_directory">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Executable.update_output_directory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_output_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the default output directory for output files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        out_dir : string (optional, default=None)</span>
<span class="sd">            If provided use this as the output directory. Else choose this</span>
<span class="sd">            automatically from the tags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the output directory</span>
        <span class="k">if</span> <span class="n">out_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="n">out_dir</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_output&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagged_name</span> <span class="o">+</span> <span class="s2">&quot;_output&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">)</span>

        <span class="c1"># Make output directory if not there</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="n">make_analysis_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_set_pegasus_profile_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the pegasus-profile settings for this Executable.</span>

<span class="sd">        These are a property of the Executable and not of nodes that it will</span>
<span class="sd">        spawn. Therefore it *cannot* be updated without also changing values</span>
<span class="sd">        for nodes that might already have been created. Therefore this is</span>
<span class="sd">        only called once in __init__. Second calls to this will fail.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Executable- and tag-specific profile information</span>
        <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;pegasus_profile-</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sec</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_ini_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span>
                                     <span class="s1">&#39;pegasus_profile-</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sec</span><span class="p">))</span></div>



<div class="viewcode-block" id="Workflow">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Workflow">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Workflow</span><span class="p">(</span><span class="n">pegasus_workflow</span><span class="o">.</span><span class="n">Workflow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class manages a pycbc workflow. It provides convenience</span>
<span class="sd">    functions for finding input files using time and keywords. It can also</span>
<span class="sd">    generate cache files from the inputs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a pycbc workflow</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        args : argparse.ArgumentParser</span>
<span class="sd">            The command line options to initialize a CBC workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Parse ini file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cp</span> <span class="o">=</span> <span class="n">WorkflowConfigParser</span><span class="o">.</span><span class="n">from_cli</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;dax_file&#39;</span><span class="p">):</span>
            <span class="n">dax_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dax_file</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dax_file</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;dax_file_directory&#39;</span><span class="p">):</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dax_file_directory</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span> <span class="ow">or</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cache_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Resolve any cache files locations</span>
            <span class="n">cache_file</span> <span class="o">=</span> <span class="n">resolve_url</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cache_file</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Workflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">workflow_name</span><span class="p">,</span>
            <span class="n">directory</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">cache_file</span><span class="o">=</span><span class="n">cache_file</span><span class="p">,</span>
            <span class="n">dax_file_name</span><span class="o">=</span><span class="n">dax_file</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Set global values</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;workflow&#39;</span><span class="p">,</span> <span class="s1">&#39;start-time&#39;</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">,</span> <span class="s2">&quot;start-time&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;workflow&#39;</span><span class="p">,</span> <span class="s1">&#39;end-time&#39;</span><span class="p">):</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">,</span> <span class="s2">&quot;end-time&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_time</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">([</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">])</span>

        <span class="c1"># Set the ifos to analyse</span>
        <span class="n">ifos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s1">&#39;workflow-ifos&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="s1">&#39;workflow-ifos&#39;</span><span class="p">):</span>
                <span class="n">ifos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ifo</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ifos</span> <span class="o">=</span> <span class="n">ifos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ifos</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_ifo_combinations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifos</span><span class="p">)</span>

        <span class="c1"># Set up input and output file lists for workflow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span> <span class="o">=</span> <span class="n">FileList</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="n">FileList</span><span class="p">([])</span>

    <span class="c1"># FIXME: Should this be in pegasus_workflow?</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;output_map&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">output_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">output_map</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_workflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.map&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;output.map&#39;</span>

        <span class="n">path</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of all possible exucution sites for jobs in this workflow&quot;&quot;&quot;</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">sites</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;pegasus_profile&#39;</span><span class="p">,</span> <span class="s1">&#39;pycbc|primary_site&#39;</span><span class="p">):</span>
            <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pegasus_profile&#39;</span><span class="p">,</span> <span class="s1">&#39;pycbc|primary_site&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The default if not chosen</span>
            <span class="n">site</span> <span class="o">=</span> <span class="s1">&#39;condorpool_symlink&#39;</span>
        <span class="n">sites</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
        <span class="n">subsections</span> <span class="o">=</span> <span class="p">[</span><span class="n">sec</span> <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span>
                       <span class="k">if</span> <span class="n">sec</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;pegasus_profile-&#39;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">subsec</span> <span class="ow">in</span> <span class="n">subsections</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">subsec</span><span class="p">,</span> <span class="s1">&#39;pycbc|site&#39;</span><span class="p">):</span>
                <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subsec</span><span class="p">,</span> <span class="s1">&#39;pycbc|site&#39;</span><span class="p">)</span>
                <span class="n">sites</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">staging_site</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Site to use for staging to/from each site&quot;&quot;&quot;</span>
        <span class="n">staging_site</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">site</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;condorpool_shared&#39;</span><span class="p">]:</span>
                <span class="n">staging_site</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">site</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">staging_site</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;local&#39;</span>
        <span class="k">return</span> <span class="n">staging_site</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">staging_site_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;=&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staging_site</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">exec_sites_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>

<div class="viewcode-block" id="Workflow.execute_node">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Workflow.execute_node">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">verbatim_exe</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Execute this node immediately on the local machine</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node</span><span class="o">.</span><span class="n">executed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check that the PFN is for a file or path</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">needs_fetching</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># The pfn may have been marked local...</span>
                <span class="n">pfn</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">get_pfn</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># or it may have been marked nonlocal.  That&#39;s</span>
                <span class="c1"># fine, we&#39;ll resolve the URL and make a local</span>
                <span class="c1"># entry.</span>
                <span class="n">pfn</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">get_pfn</span><span class="p">(</span><span class="s1">&#39;nonlocal&#39;</span><span class="p">)</span>

            <span class="n">resolved</span> <span class="o">=</span> <span class="n">resolve_url</span><span class="p">(</span>
                <span class="n">pfn</span><span class="p">,</span>
                <span class="n">permissions</span><span class="o">=</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXUSR</span>
            <span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">clear_pfns</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">add_pfn</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="s1">&#39;file:&#39;</span><span class="p">,</span> <span class="n">pathname2url</span><span class="p">(</span><span class="n">resolved</span><span class="p">)),</span>
                                    <span class="n">site</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>

        <span class="n">cmd_list</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_command_line</span><span class="p">()</span>

        <span class="c1"># Must execute in output directory.</span>
        <span class="n">curr_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">out_dir</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>

        <span class="c1"># Make call</span>
        <span class="n">make_external_call</span><span class="p">(</span><span class="n">cmd_list</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">),</span>
                           <span class="n">out_basename</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># Change back</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">curr_dir</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fil</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">_outputs</span><span class="p">:</span>
            <span class="n">fil</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">fil</span><span class="o">.</span><span class="n">add_pfn</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="s1">&#39;file:&#39;</span><span class="p">,</span> <span class="n">pathname2url</span><span class="p">(</span><span class="n">fil</span><span class="o">.</span><span class="n">storage_path</span><span class="p">)),</span>
                        <span class="n">site</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Workflow.save">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Workflow.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_map_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># FIXME: Too close to pegasus to live here and not in pegasus_workflow</span>

        <span class="k">if</span> <span class="n">output_map_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_map_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_map</span>

        <span class="n">output_map_file</span> <span class="o">=</span> <span class="n">pegasus_workflow</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">output_map_path</span><span class="p">))</span>
        <span class="n">output_map_file</span><span class="o">.</span><span class="n">add_pfn</span><span class="p">(</span><span class="n">output_map_path</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_map_file</span> <span class="o">=</span> <span class="n">output_map_file</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_workflow</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_as_job</span><span class="o">.</span><span class="n">set_subworkflow_properties</span><span class="p">(</span>
                <span class="n">output_map_file</span><span class="p">,</span>
                <span class="n">staging_site</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">staging_site</span><span class="p">,</span>
                <span class="n">cache_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_as_job</span><span class="o">.</span><span class="n">add_planner_args</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_as_job</span><span class="o">.</span><span class="n">pycbc_planner_args</span><span class="p">)</span>

        <span class="c1"># add transformations to dax</span>
        <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transformations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_transformation</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_container</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>

        <span class="c1"># save the configuration file</span>
        <span class="n">ini_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.ini&#39;</span><span class="p">)</span>

        <span class="c1"># This shouldn&#39;t already exist, but just in case</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ini_file</span><span class="p">):</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Refusing to overwrite configuration file that &quot;</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;shouldn&#39;t be there: &quot;</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="n">ini_file</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ini_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

        <span class="c1"># save the sites file</span>
        <span class="c1"># checking for in_workflow prevents sub-workflows from making</span>
        <span class="c1"># extra unused sites.yml</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_workflow</span><span class="p">:</span>
            <span class="n">catalog_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;sites.yml&#39;</span><span class="p">)</span>
            <span class="n">make_catalog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">catalog_path</span><span class="p">)</span>

        <span class="c1"># save the dax file</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Workflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                                   <span class="n">output_map_path</span><span class="o">=</span><span class="n">output_map_path</span><span class="p">,</span>
                                   <span class="n">submit_now</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">submit_now</span><span class="p">,</span>
                                   <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">)</span></div>


<div class="viewcode-block" id="Workflow.save_config">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Workflow.save_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">cp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Writes configuration file to disk and returns a pycbc.workflow.File</span>
<span class="sd">        instance for the configuration file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        fname : string</span>
<span class="sd">            The filename of the configuration file written to disk.</span>
<span class="sd">        output_dir : string</span>
<span class="sd">            The directory where the file is written to disk.</span>
<span class="sd">        cp : ConfigParser object</span>
<span class="sd">            The ConfigParser object to write. If None then uses self.cp.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FileList</span>
<span class="sd">            The FileList object with the configuration file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span> <span class="k">if</span> <span class="n">cp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cp</span>
        <span class="n">ini_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ini_file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">ini_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifos</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_time</span><span class="p">,</span>
                        <span class="n">file_url</span><span class="o">=</span><span class="s2">&quot;file://&quot;</span> <span class="o">+</span> <span class="n">ini_file_path</span><span class="p">)</span>
        <span class="c1"># set the physical file name</span>
        <span class="n">ini_file</span><span class="o">.</span><span class="n">add_pfn</span><span class="p">(</span><span class="n">ini_file_path</span><span class="p">,</span> <span class="s2">&quot;local&quot;</span><span class="p">)</span>
        <span class="c1"># set the storage path to be the same</span>
        <span class="n">ini_file</span><span class="o">.</span><span class="n">storage_path</span> <span class="o">=</span> <span class="n">ini_file_path</span>
        <span class="k">return</span> <span class="n">FileList</span><span class="p">([</span><span class="n">ini_file</span><span class="p">])</span></div>


<div class="viewcode-block" id="Workflow.get_ifo_combinations">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Workflow.get_ifo_combinations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_ifo_combinations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of strings for all possible combinations of IFOs</span>
<span class="sd">        in the workflow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ifo_combinations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifos</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifo_combinations</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ifos</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ifos</span> <span class="ow">in</span>
                                      <span class="n">combinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifos</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span></div>
</div>



<div class="viewcode-block" id="Node">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Node">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">(</span><span class="n">pegasus_workflow</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">valid_seg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">executable</span><span class="o">.</span><span class="n">get_transformation</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">executable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_category</span><span class="p">(</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_seg</span> <span class="o">=</span> <span class="n">valid_seg</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">common_options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_options</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">common_raw_options</span>
        <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">common_input_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_input</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">time_dependent_options</span><span class="p">):</span>
            <span class="c1"># Resolving these options requires the concept of a valid time.</span>
            <span class="c1"># To keep backwards compatibility we will allow this to work if</span>
            <span class="c1"># valid_seg is not supplied and no option actually needs resolving.</span>
            <span class="c1"># It would be good to get this from the workflow&#39;s valid_seg if</span>
            <span class="c1"># not overriden. But the Node is not connected to the Workflow</span>
            <span class="c1"># until the dax starts to be written.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resolve_td_options</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">unresolved_td_options</span><span class="p">)</span>

<div class="viewcode-block" id="Node.get_command_line">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Node.get_command_line">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_command_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># FIXME: Put in pegasus_workflow??</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span><span class="p">()</span>
        <span class="n">arglist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dax_node</span><span class="o">.</span><span class="n">arguments</span>

        <span class="n">tmpargs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arglist</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">File</span><span class="p">):</span>
                <span class="n">tmpargs</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmpargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">arglist</span> <span class="o">=</span> <span class="n">tmpargs</span>

        <span class="n">arglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arglist</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

        <span class="n">arglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">storage_path</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">File</span><span class="p">)</span> <span class="k">else</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arglist</span><span class="p">]</span>

        <span class="c1"># This allows the pfn to be an http(s) URL, which will be</span>
        <span class="c1"># downloaded by resolve_url</span>
        <span class="n">exe_path</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">get_pfn</span><span class="p">())</span><span class="o">.</span><span class="n">path</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">exe_path</span><span class="p">]</span> <span class="o">+</span> <span class="n">arglist</span></div>


<div class="viewcode-block" id="Node.new_output_file_opt">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Node.new_output_file_opt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">new_output_file_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valid_seg</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="n">option_name</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">store_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_tmp_subdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function will create a workflow.File object corresponding to the given</span>
<span class="sd">        information and then add that file as output of this node.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        valid_seg : igwn_segments.segment</span>
<span class="sd">            The time span over which the job is valid for.</span>
<span class="sd">        extension : string</span>
<span class="sd">            The extension to be used at the end of the filename.</span>
<span class="sd">            E.g. &#39;.xml&#39; or &#39;.sqlite&#39;.</span>
<span class="sd">        option_name : string</span>
<span class="sd">            The option that is used when setting this job as output. For e.g.</span>
<span class="sd">            &#39;output-name&#39; or &#39;output-file&#39;, whatever is appropriate for the</span>
<span class="sd">            current executable.</span>
<span class="sd">        tags : list of strings, (optional, default=[])</span>
<span class="sd">            These tags will be added to the list of tags already associated with</span>
<span class="sd">            the job. They can be used to uniquely identify this output file.</span>
<span class="sd">        store_file : Boolean, (optional, default=True)</span>
<span class="sd">            This file is to be added to the output mapper and will be stored</span>
<span class="sd">            in the specified output location if True. If false file will be</span>
<span class="sd">            removed when no longer needed in the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Changing this from set(tags) to enforce order. It might make sense</span>
        <span class="c1"># for all jobs to have file names with tags in the same order.</span>
        <span class="n">all_tags</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_tags</span><span class="p">:</span>
                <span class="n">all_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

        <span class="n">store_file</span> <span class="o">=</span> <span class="n">store_file</span> <span class="k">if</span> <span class="n">store_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">retain_files</span>

        <span class="n">fil</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                   <span class="n">valid_seg</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">,</span> <span class="n">store_file</span><span class="o">=</span><span class="n">store_file</span><span class="p">,</span>
                   <span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">all_tags</span><span class="p">,</span>
                   <span class="n">use_tmp_subdirs</span><span class="o">=</span><span class="n">use_tmp_subdirs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output_opt</span><span class="p">(</span><span class="n">option_name</span><span class="p">,</span> <span class="n">fil</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fil</span></div>


<div class="viewcode-block" id="Node.add_multiifo_input_list_opt">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Node.add_multiifo_input_list_opt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_multiifo_input_list_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add an option that determines a list of inputs from multiple</span>
<span class="sd">            detectors. Files will be supplied as --opt ifo1:input1 ifo2:input2</span>
<span class="sd">            .....</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: Here we have to use the raw arguments functionality as the</span>
        <span class="c1">#       file and ifo are not space separated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">ifo</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_input</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span></div>


<div class="viewcode-block" id="Node.add_multiifo_output_list_opt">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Node.add_multiifo_output_list_opt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_multiifo_output_list_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add an option that determines a list of outputs from multiple</span>
<span class="sd">            detectors. Files will be supplied as --opt ifo1:input1 ifo2:input2</span>
<span class="sd">            .....</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: Here we have to use the raw arguments functionality as the</span>
        <span class="c1">#       file and ifo are not space separated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">outfile</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="n">outfile</span><span class="o">.</span><span class="n">ifo</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_raw_arg</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span></div>


<div class="viewcode-block" id="Node.new_multiifo_output_list_opt">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Node.new_multiifo_output_list_opt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">new_multiifo_output_list_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">ifos</span><span class="p">,</span> <span class="n">analysis_time</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span>
                                     <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">store_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">use_tmp_subdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add an option that determines a list of outputs from multiple</span>
<span class="sd">            detectors. Files will be supplied as --opt ifo1:input1 ifo2:input2</span>
<span class="sd">            .....</span>
<span class="sd">            File names are created internally from the provided extension and</span>
<span class="sd">            analysis time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_tags</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_tags</span><span class="p">:</span>
                <span class="n">all_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

        <span class="n">output_files</span> <span class="o">=</span> <span class="n">FileList</span><span class="p">([])</span>
        <span class="n">store_file</span> <span class="o">=</span> <span class="n">store_file</span> <span class="k">if</span> <span class="n">store_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                                              <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">retain_files</span>

        <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">ifos</span><span class="p">:</span>
            <span class="n">curr_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">analysis_time</span><span class="p">,</span>
                             <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">,</span> <span class="n">store_file</span><span class="o">=</span><span class="n">store_file</span><span class="p">,</span>
                             <span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">all_tags</span><span class="p">,</span>
                             <span class="n">use_tmp_subdirs</span><span class="o">=</span><span class="n">use_tmp_subdirs</span><span class="p">)</span>
            <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_multiifo_output_list_opt</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">output_files</span><span class="p">)</span></div>


<div class="viewcode-block" id="Node.resolve_td_options">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.Node.resolve_td_options">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_td_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">td_options</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">td_options</span><span class="p">:</span>
            <span class="n">new_opt</span> <span class="o">=</span> <span class="n">resolve_td_option</span><span class="p">(</span><span class="n">td_options</span><span class="p">[</span><span class="n">opt</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_seg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="o">+=</span> <span class="p">[</span><span class="n">opt</span><span class="p">,</span> <span class="n">new_opt</span><span class="p">]</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FileList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If only one output file return it. Otherwise raise an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_files</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;output_file property is only valid if there is a single&quot;</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot; output file. Here there are &quot;</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> output files.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_files</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="File">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.File">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">File</span><span class="p">(</span><span class="n">pegasus_workflow</span><span class="o">.</span><span class="n">File</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class holds the details of an individual output file</span>
<span class="sd">    This file(s) may be pre-supplied, generated from within the workflow</span>
<span class="sd">    command line script, or generated within the workflow. The important stuff</span>
<span class="sd">    is:</span>

<span class="sd">    * The ifo that the File is valid for</span>
<span class="sd">    * The time span that the OutFile is valid for</span>
<span class="sd">    * A short description of what the file is</span>
<span class="sd">    * The extension that the file should have</span>
<span class="sd">    * The url where the file should be located</span>

<span class="sd">    An example of initiating this class:</span>

<span class="sd">    &gt;&gt; c = File(&quot;H1&quot;, &quot;INSPIRAL_S6LOWMASS&quot;, segments.segment(815901601, 815902001), file_url=&quot;file://localhost/home/spxiwh/H1-INSPIRAL_S6LOWMASS-815901601-400.xml.gz&quot; )</span>

<span class="sd">    another where the file url is generated from the inputs:</span>

<span class="sd">    &gt;&gt; c = File(&quot;H1&quot;, &quot;INSPIRAL_S6LOWMASS&quot;, segments.segment(815901601, 815902001), directory=&quot;/home/spxiwh&quot;, extension=&quot;xml.gz&quot; )</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifos</span><span class="p">,</span> <span class="n">exe_name</span><span class="p">,</span> <span class="n">segs</span><span class="p">,</span> <span class="n">file_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">extension</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">store_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_tmp_subdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a File instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ifos : string or list</span>
<span class="sd">            The ifo(s) that the File is valid for. If the file is</span>
<span class="sd">            independently valid for multiple ifos it can be provided as a list.</span>
<span class="sd">            Ie. [&#39;H1&#39;,L1&#39;,&#39;V1&#39;], if the file is only valid for the combination</span>
<span class="sd">            of ifos (for e.g. ligolw_thinca output) then this can be supplied</span>
<span class="sd">            as, for e.g. &quot;H1L1V1&quot;.</span>
<span class="sd">        exe_name: string</span>
<span class="sd">            A short description of the executable description, tagging</span>
<span class="sd">            only the program that ran this job.</span>
<span class="sd">        segs : igwn_segments.segment or igwn_segments.segmentlist</span>
<span class="sd">            The time span that the OutFile is valid for. Note that this is</span>
<span class="sd">            *not* the same as the data that the job that made the file reads in.</span>
<span class="sd">            Lalapps_inspiral jobs do not analyse the first an last 72s of the</span>
<span class="sd">            data that is read, and are therefore not valid at those times. If</span>
<span class="sd">            the time is not continuous a segmentlist can be supplied.</span>
<span class="sd">        file_url : url (optional, default=None)</span>
<span class="sd">            If this is *not* supplied, extension and directory must be given.</span>
<span class="sd">            If specified this explicitly points to the url of the file, or the</span>
<span class="sd">            url where the file will be generated when made in the workflow.</span>
<span class="sd">        extension : string (optional, default=None)</span>
<span class="sd">            Either supply this *and* directory *or* supply only file_url.</span>
<span class="sd">            If given this gives the extension at the end of the file name. The</span>
<span class="sd">            full file name will be inferred from the other arguments</span>
<span class="sd">            following the workflow standard.</span>
<span class="sd">        directory : string (optional, default=None)</span>
<span class="sd">            Either supply this *and* extension *or* supply only file_url.</span>
<span class="sd">            If given this gives the directory in which the file exists, or will</span>
<span class="sd">            exists. The file name will be inferred from the other arguments</span>
<span class="sd">            following the workflow standard.</span>
<span class="sd">        tags : list of strings (optional, default=None)</span>
<span class="sd">            This is a list of descriptors describing what this file is. For</span>
<span class="sd">            e.g. this might be [&quot;BNSINJECTIONS&quot; ,&quot;LOWMASS&quot;,&quot;CAT_2_VETO&quot;].</span>
<span class="sd">            These are used in file naming.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Set the science metadata on the file</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ifos</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ifos</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span> <span class="o">=</span> <span class="n">ifos</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span> <span class="o">=</span> <span class="s1">&#39;file&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">exe_name</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">segs</span><span class="p">,</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">([</span><span class="n">segs</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">segs</span><span class="p">,</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span> <span class="o">=</span> <span class="n">segs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">segs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">segs</span> <span class="o">=</span> <span class="p">[</span><span class="n">segs</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">,</span> <span class="n">segs</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">exc</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;segs input must be either igwn_segments.segment or &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;igwn_segments.segmentlist. Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">segs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span>

        <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;DO NOT GIVE EMPTY TAGS (from </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">exe_name</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tag_str</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
            <span class="n">tagged_description</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">]</span> <span class="o">+</span> <span class="n">tags</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tagged_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>

        <span class="c1"># Follow the capitals-for-naming convention</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tagged_description</span> <span class="o">=</span> <span class="n">tagged_description</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_url</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">extension</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;a file extension required if a file_url &quot;</span>
                                <span class="s2">&quot;is not provided&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;a directory is required if a file_url is &quot;</span>
                                <span class="s2">&quot;not provided&quot;</span><span class="p">)</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagged_description</span><span class="p">,</span>
                                      <span class="n">extension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span><span class="o">.</span><span class="n">extent</span><span class="p">())</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">file_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlunparse</span><span class="p">([</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
                                                <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">use_tmp_subdirs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span><span class="p">):</span>
            <span class="n">pegasus_lfn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span><span class="o">.</span><span class="n">extent</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">pegasus_lfn</span> <span class="o">=</span> <span class="n">pegasus_lfn</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pegasus_lfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_url</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">pegasus_lfn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">store_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">file_url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Allow the workflow.File to be picklable. This disables the usage of</span>
<span class="sd">        the internal cache entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">seg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_entry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">safe_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">safe_dict</span><span class="p">[</span><span class="s1">&#39;cache_entry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">safe_dict</span>

    <span class="c1"># FIXME: This is a pegasus_workflow thing (don&#39;t think it&#39;s needed at all!)</span>
    <span class="c1">#        use the pegasus function directly (maybe not).</span>
<div class="viewcode-block" id="File.add_metadata">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.File.add_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add arbitrary metadata to this file &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ifo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If only one ifo in the ifo_list this will be that ifo. Otherwise an</span>
<span class="sd">        error is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;self.ifo_list must contain only one ifo to access the &quot;</span>
            <span class="n">err</span> <span class="o">+=</span> <span class="s2">&quot;ifo property. </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">),)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">segment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If only one segment in the segmentlist this will be that segment.</span>
<span class="sd">        Otherwise an error is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;self.segment_list must only contain one segment to access&quot;</span>
            <span class="n">err</span> <span class="o">+=</span> <span class="s2">&quot; the segment property. </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span><span class="p">),)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cache_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CacheEntry instance for File.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;This file is temporary and so a lal &#39;</span>
                             <span class="s1">&#39;cache entry cannot be made&#39;</span><span class="p">)</span>

        <span class="n">file_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlunparse</span><span class="p">([</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                            <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">cache_entry</span> <span class="o">=</span> <span class="n">lal</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">CacheEntry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifo_string</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">tagged_description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span><span class="o">.</span><span class="n">extent</span><span class="p">(),</span> <span class="n">file_url</span><span class="p">)</span>
        <span class="n">cache_entry</span><span class="o">.</span><span class="n">workflow_file</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">cache_entry</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="n">segment</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the standard output filename. Should only be used internally</span>
<span class="sd">        of the File class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">extension</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">extension</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Follow the frame convention of using integer filenames,</span>
        <span class="c1"># but stretching to cover partially covered seconds.</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ifo</span><span class="p">,</span> <span class="n">description</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">start</span><span class="p">,</span>
                                   <span class="n">duration</span><span class="p">,</span> <span class="n">extension</span><span class="p">)</span>

<div class="viewcode-block" id="File.from_path">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.File.from_path">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an output File object from path, with optional attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">and</span> <span class="s1">&#39;ifos&#39;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">ifos</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ifos&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ifos</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;K1&#39;</span><span class="p">,</span> <span class="s1">&#39;L1&#39;</span><span class="p">,</span> <span class="s1">&#39;V1&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">and</span> <span class="s1">&#39;exe_name&#39;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">exe_name</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;exe_name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exe_name</span> <span class="o">=</span> <span class="s1">&#39;INPUT&#39;</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">and</span> <span class="s1">&#39;segs&#39;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">segs</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;segs&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">segs</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2000000000</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">and</span> <span class="s1">&#39;tags&#39;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">curr_file</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">ifos</span><span class="p">,</span> <span class="n">exe_name</span><span class="p">,</span> <span class="n">segs</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">curr_file</span></div>
</div>


<div class="viewcode-block" id="FileList">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FileList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class holds a list of File objects. It inherits from the</span>
<span class="sd">    built-in list class, but also allows a number of features. ONLY</span>
<span class="sd">    pycbc.workflow.File instances should be within a FileList instance.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">entry_class</span> <span class="o">=</span> <span class="n">File</span>

<div class="viewcode-block" id="FileList.categorize_by_attr">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.categorize_by_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">categorize_by_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to categorize a FileList by a File object</span>
<span class="sd">        attribute (eg. &#39;segment&#39;, &#39;ifo&#39;, &#39;description&#39;).</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        attribute : string</span>
<span class="sd">           File object attribute to categorize FileList</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        keys : list</span>
<span class="sd">           A list of values for an attribute</span>
<span class="sd">        groups : list</span>
<span class="sd">           A list of FileLists</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># need to sort FileList otherwise using groupby without sorting does</span>
        <span class="c1"># &#39;AAABBBCCDDAABB&#39; -&gt; [&#39;AAA&#39;,&#39;BBB&#39;,&#39;CC&#39;,&#39;DD&#39;,&#39;AA&#39;,&#39;BB&#39;]</span>
        <span class="c1"># and using groupby with sorting does</span>
        <span class="c1"># &#39;AAABBBCCDDAABB&#39; -&gt; [&#39;AAAAA&#39;,&#39;BBBBB&#39;,&#39;CC&#39;,&#39;DD&#39;]</span>
        <span class="n">flist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">attribute</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># use groupby to create lists</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">flist</span><span class="p">,</span> <span class="n">attrgetter</span><span class="p">(</span><span class="n">attribute</span><span class="p">)):</span>
            <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FileList</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">keys</span><span class="p">,</span> <span class="n">groups</span></div>


<div class="viewcode-block" id="FileList.find_output">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.find_output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns one File most appropriate at the given time/time range.</span>

<span class="sd">        Return one File that covers the given time, or is most</span>
<span class="sd">        appropriate for the supplied time range.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        ifo : string</span>
<span class="sd">           Name of the ifo (or ifos) that the file should be valid for.</span>
<span class="sd">        time : int/float/LIGOGPStime or tuple containing two values</span>
<span class="sd">           If int/float/LIGOGPStime (or similar may of specifying one time) is</span>
<span class="sd">           given, return the File corresponding to the time. This calls</span>
<span class="sd">           self.find_output_at_time(ifo,time).</span>
<span class="sd">           If a tuple of two values is given, return the File that is</span>
<span class="sd">           **most appropriate** for the time range given. This calls</span>
<span class="sd">           self.find_output_in_range</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        pycbc_file : pycbc.workflow.File instance</span>
<span class="sd">           The File that corresponds to the time or time range</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Determine whether I have a specific time, or a range of times</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lenTime</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># This is if I have a single time</span>
            <span class="n">outFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_output_at_time</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span><span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is if I have a range of times</span>
            <span class="k">if</span> <span class="n">lenTime</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">outFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_output_in_range</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># This is if I got a list that had more (or less) than 2 entries</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;I do not understand the input variable time&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outFile</span></div>


<div class="viewcode-block" id="FileList.find_output_at_time">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.find_output_at_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_output_at_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return File that covers the given time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        ifo : string</span>
<span class="sd">           Name of the ifo (or ifos) that the File should correspond to</span>
<span class="sd">        time : int/float/LIGOGPStime</span>
<span class="sd">           Return the Files that covers the supplied time. If no</span>
<span class="sd">           File covers the time this will return None.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        list of File classes</span>
<span class="sd">           The Files that corresponds to the time.</span>
<span class="sd">         &#39;&#39;&#39;</span>
        <span class="c1"># Get list of Files that overlap time, for given ifo</span>
        <span class="n">outFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">ifo_list</span> <span class="ow">and</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">segment_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outFiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># No OutFile at this time</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">outFiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># 1 OutFile at this time (good!)</span>
            <span class="k">return</span> <span class="n">outFiles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiple output files. Currently this is valid, but we may want</span>
            <span class="c1"># to demand exclusivity later, or in certain cases. Hence the</span>
            <span class="c1"># separation.</span>
            <span class="k">return</span> <span class="n">outFiles</span></div>


<div class="viewcode-block" id="FileList.find_outputs_in_range">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.find_outputs_in_range">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_outputs_in_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span> <span class="n">current_segment</span><span class="p">,</span> <span class="n">useSplitLists</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of Files that is most appropriate for the supplied</span>
<span class="sd">        time range. That is, the Files whose coverage time has the</span>
<span class="sd">        largest overlap with the supplied time range.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        ifo : string</span>
<span class="sd">           Name of the ifo (or ifos) that the File should correspond to</span>
<span class="sd">        current_segment : igwn_segments.segment</span>
<span class="sd">           The segment of time that files must intersect.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        FileList class</span>
<span class="sd">           The list of Files that are most appropriate for the time range</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">currsegment_list</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">([</span><span class="n">current_segment</span><span class="p">])</span>

        <span class="c1"># Get all files overlapping the window</span>
        <span class="n">overlap_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_all_output_in_range</span><span class="p">(</span><span class="n">ifo</span><span class="p">,</span> <span class="n">current_segment</span><span class="p">,</span>
                                                    <span class="n">useSplitLists</span><span class="o">=</span><span class="n">useSplitLists</span><span class="p">)</span>

        <span class="c1"># By how much do they overlap?</span>
        <span class="n">overlap_windows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">segment_list</span> <span class="o">&amp;</span> <span class="n">currsegment_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">overlap_files</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">overlap_windows</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Return the File with the biggest overlap</span>
        <span class="c1"># Note if two File have identical overlap, the first is used</span>
        <span class="c1"># to define the valid segment</span>
        <span class="n">overlap_windows</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">overlap_windows</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">segmentLst</span> <span class="o">=</span> <span class="n">overlap_files</span><span class="p">[</span><span class="n">overlap_windows</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span><span class="o">.</span><span class="n">segment_list</span>

        <span class="c1"># Get all output files with the exact same segment definition</span>
        <span class="n">output_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">overlap_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">segment_list</span><span class="o">==</span><span class="n">segmentLst</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">output_files</span></div>


<div class="viewcode-block" id="FileList.find_output_in_range">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.find_output_in_range">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_output_in_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the File that is most appropriate for the supplied</span>
<span class="sd">        time range. That is, the File whose coverage time has the</span>
<span class="sd">        largest overlap with the supplied time range. If no Files</span>
<span class="sd">        overlap the supplied time window, will return None.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        ifo : string</span>
<span class="sd">           Name of the ifo (or ifos) that the File should correspond to</span>
<span class="sd">        start : int/float/LIGOGPStime</span>
<span class="sd">           The start of the time range of interest.</span>
<span class="sd">        end : int/float/LIGOGPStime</span>
<span class="sd">           The end of the time range of interest</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        File class</span>
<span class="sd">           The File that is most appropriate for the time range</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">currsegment_list</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">([</span><span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)])</span>

        <span class="c1"># First filter Files corresponding to ifo</span>
        <span class="n">outFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outFiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># No OutFiles correspond to that ifo</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Filter OutFiles to those overlapping the given window</span>
        <span class="n">currSeg</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">([</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">])</span>
        <span class="n">outFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outFiles</span> \
                                  <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">segment_list</span><span class="o">.</span><span class="n">intersects_segment</span><span class="p">(</span><span class="n">currSeg</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outFiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># No OutFile overlap that time period</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">outFiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># One OutFile overlaps that period</span>
            <span class="k">return</span> <span class="n">outFiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overlap_windows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">segment_list</span> <span class="o">&amp;</span> <span class="n">currsegment_list</span><span class="p">)</span> \
                                                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outFiles</span><span class="p">]</span>
            <span class="c1"># Return the File with the biggest overlap</span>
            <span class="c1"># Note if two File have identical overlap, this will return</span>
            <span class="c1"># the first File in the list</span>
            <span class="n">overlap_windows</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">overlap_windows</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">outFiles</span><span class="p">[</span><span class="n">overlap_windows</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span></div>


<div class="viewcode-block" id="FileList.find_all_output_in_range">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.find_all_output_in_range">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_all_output_in_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span> <span class="n">currSeg</span><span class="p">,</span> <span class="n">useSplitLists</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all files that overlap the specified segment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">useSplitLists</span><span class="p">:</span>
            <span class="c1"># Slower, but simpler method</span>
            <span class="n">outFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">]</span>
            <span class="n">outFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outFiles</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">segment_list</span><span class="o">.</span><span class="n">intersects_segment</span><span class="p">(</span><span class="n">currSeg</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Faster, but more complicated</span>
            <span class="c1"># Basically only check if a subset of files intersects_segment by</span>
            <span class="c1"># using a presorted list. Sorting only happens once.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_split_list_validity</span><span class="p">():</span>
                <span class="c1"># FIXME: DO NOT hard code this.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_temporal_split_list</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">startIdx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">currSeg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsStart</span><span class="p">)</span> <span class="o">/</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsStep</span><span class="p">)</span>
            <span class="c1"># Add some small rounding here</span>
            <span class="n">endIdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">currSeg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsStart</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsStep</span>
            <span class="n">endIdx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">endIdx</span> <span class="o">-</span> <span class="mf">0.000001</span><span class="p">)</span>

            <span class="n">outFiles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startIdx</span><span class="p">,</span> <span class="n">endIdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsNum</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">outFilesTemp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitLists</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">]</span>
                <span class="n">outFiles</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outFilesTemp</span>
                                 <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">segment_list</span><span class="o">.</span><span class="n">intersects_segment</span><span class="p">(</span><span class="n">currSeg</span><span class="p">)])</span>
                <span class="c1"># Remove duplicates</span>
                <span class="n">outFiles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">outFiles</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">outFiles</span><span class="p">)</span></div>


<div class="viewcode-block" id="FileList.find_output_with_tag">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.find_output_with_tag">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_output_with_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">fail_if_not_single_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all files who have tag in self.tags</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        tag : string</span>
<span class="sd">           Tag used to seive the file names</span>
<span class="sd">        fail_if_not_single_file : boolean</span>
<span class="sd">           kwarg (default is False) that triggers a sanity check if the</span>
<span class="sd">           user expects to find a single file with the desired tag in its name</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        FileList/File class</span>
<span class="sd">           If fail_if_not_single_file is False the FileList</span>
<span class="sd">           Containing File instances with tag in self.tags is returned,</span>
<span class="sd">           otherwise the single File with tag in self.tags is returned</span>
<span class="sd">           (if the sanity check requested with fail_if_not_single_file=True is</span>
<span class="sd">           passed)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Enforce upper case</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">matching_files</span> <span class="o">=</span> <span class="n">FileList</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">fail_if_not_single_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;More than one file with tag </span><span class="si">%s</span><span class="s2"> was found.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="n">matching_files</span> <span class="o">=</span> <span class="n">matching_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">matching_files</span></div>


<div class="viewcode-block" id="FileList.find_output_without_tag">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.find_output_without_tag">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_output_without_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all files who do not have tag in self.tags</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Enforce upper case</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">FileList</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">])</span></div>


<div class="viewcode-block" id="FileList.find_output_with_ifo">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.find_output_with_ifo">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_output_with_ifo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifo</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all files who have ifo = ifo</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Enforce upper case</span>
        <span class="n">ifo</span> <span class="o">=</span> <span class="n">ifo</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">FileList</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">ifo_list</span><span class="p">])</span></div>


<div class="viewcode-block" id="FileList.get_times_covered_by_files">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.get_times_covered_by_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_times_covered_by_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the coalesced intersection of the segments of all files in the</span>
<span class="sd">        list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">times</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">segment_list</span><span class="p">)</span>
        <span class="n">times</span><span class="o">.</span><span class="n">coalesce</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">times</span></div>


<div class="viewcode-block" id="FileList.convert_to_lal_cache">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.convert_to_lal_cache">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_to_lal_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all files in this object as a glue.lal.Cache object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">glue</span><span class="w"> </span><span class="kn">import</span> <span class="n">lal</span> <span class="k">as</span> <span class="n">gluelal</span>

        <span class="n">lal_cache</span> <span class="o">=</span> <span class="n">gluelal</span><span class="o">.</span><span class="n">Cache</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lal_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">cache_entry</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">lal_cache</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_temporal_split_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">numSubLists</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This internal function is used to speed the code up in cases where a</span>
<span class="sd">        number of operations are being made to determine if files overlap a</span>
<span class="sd">        specific time. Normally such operations are done on *all* entries with</span>
<span class="sd">        *every* call. However, if we predetermine which files are at which</span>
<span class="sd">        times, we can avoid testing *every* file every time.</span>

<span class="sd">        We therefore create numSubLists distinct and equal length time windows</span>
<span class="sd">        equally spaced from the first time entry in the list until the last.</span>
<span class="sd">        A list is made for each window and files are added to lists which they</span>
<span class="sd">        overlap.</span>

<span class="sd">        If the list changes it should be captured and these split lists become</span>
<span class="sd">        invalid. Currently the testing for this is pretty basic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assume segment lists are coalesced!</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="nb">min</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">segment_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]))</span>
        <span class="n">endTime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="nb">max</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">segment_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]))</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">numSubLists</span><span class="p">)</span>

        <span class="c1"># Set up storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splitLists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numSubLists</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_splitLists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FileList</span><span class="p">([]))</span>

        <span class="c1"># Sort the files</span>

        <span class="k">for</span> <span class="n">currFile</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">segExtent</span> <span class="o">=</span> <span class="n">currFile</span><span class="o">.</span><span class="n">segment_list</span><span class="o">.</span><span class="n">extent</span><span class="p">()</span>
            <span class="n">startIdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">segExtent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span>
            <span class="n">endIdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">segExtent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span>
            <span class="c1"># Add some small rounding here</span>
            <span class="n">startIdx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">startIdx</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">)</span>
            <span class="n">endIdx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">endIdx</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">startIdx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">startIdx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">endIdx</span> <span class="o">&gt;=</span> <span class="n">numSubLists</span><span class="p">:</span>
                <span class="n">endIdx</span> <span class="o">=</span> <span class="n">numSubLists</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startIdx</span><span class="p">,</span> <span class="n">endIdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_splitLists</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currFile</span><span class="p">)</span>

        <span class="c1"># Set information needed to detect changes and to be used elsewhere</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsNum</span> <span class="o">=</span> <span class="n">numSubLists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsStart</span> <span class="o">=</span> <span class="n">startTime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsEnd</span> <span class="o">=</span> <span class="n">endTime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsStep</span> <span class="o">=</span> <span class="n">step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsSet</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_split_list_validity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See _temporal_split_list above. This function checks if the current</span>
<span class="sd">        split lists are still valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME: Currently very primitive, but needs to be fast</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;_splitListsSet&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_splitListsSet</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitListsLength</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="FileList.load">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.load">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a FileList from a pickle file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="FileList.dump">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.dump">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output this FileList to a pickle file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="FileList.to_file_object">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.FileList.to_file_object">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_file_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dump to a pickle file and return an File object reference</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            An identifier of this file. Needs to be unique.</span>
<span class="sd">        out_dir : path</span>
<span class="sd">            path to place this file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        file : AhopeFile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">make_analysis_dir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>

        <span class="n">file_ref</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_times_covered_by_files</span><span class="p">(),</span>
                             <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">out_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">file_ref</span><span class="o">.</span><span class="n">storage_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_ref</span></div>
</div>



<div class="viewcode-block" id="SegFile">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.SegFile">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SegFile</span><span class="p">(</span><span class="n">File</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class inherits from the File class, and is designed to store</span>
<span class="sd">    workflow output files containing a segment dict. This is identical in</span>
<span class="sd">    usage to File except for an additional kwarg for holding the</span>
<span class="sd">    segment dictionary, if it is known at workflow run time.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifo_list</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">valid_segment</span><span class="p">,</span>
                 <span class="n">segment_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seg_summ_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See File.__init__ for a full set of documentation for how to</span>
<span class="sd">        call this class. The only thing unique and added to this class is</span>
<span class="sd">        the optional segment_dict. NOTE that while segment_dict is a</span>
<span class="sd">        igwn_segments.segmentlistdict rather than the usual dict[ifo]</span>
<span class="sd">        we key by dict[ifo:name].</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        ifo_list : string or list (required)</span>
<span class="sd">            See File.__init__</span>
<span class="sd">        description : string (required)</span>
<span class="sd">            See File.__init__</span>
<span class="sd">        segment : igwn_segments.segment or igwn_segments.segmentlist</span>
<span class="sd">            See File.__init__</span>
<span class="sd">        segment_dict : igwn_segments.segmentlistdict (optional, default=None)</span>
<span class="sd">            A igwn_segments.segmentlistdict covering the times covered by the</span>
<span class="sd">            segmentlistdict associated with this file.</span>
<span class="sd">            Can be added by setting self.segment_dict after initializing an</span>
<span class="sd">            instance of the class.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SegFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ifo_list</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">valid_segment</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># To avoid confusion with the segment_list property of the parent class</span>
        <span class="c1"># we refer to this as valid_segments here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segment_dict</span> <span class="o">=</span> <span class="n">segment_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seg_summ_dict</span> <span class="o">=</span> <span class="n">seg_summ_dict</span>

<div class="viewcode-block" id="SegFile.from_segment_list">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.SegFile.from_segment_list">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_segment_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">segmentlist</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span>
                          <span class="n">seg_summ_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize a SegFile object from a segmentlist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        description : string (required)</span>
<span class="sd">            See File.__init__</span>
<span class="sd">        segmentlist : igwn_segments.segmentslist</span>
<span class="sd">            The segment list that will be stored in this file.</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the segment lists to be stored in the file.</span>
<span class="sd">        ifo : str</span>
<span class="sd">            The ifo of the segment lists to be stored in this file.</span>
<span class="sd">        seg_summ_list : igwn_segments.segmentslist (OPTIONAL)</span>
<span class="sd">            Specify the segment_summary segmentlist that goes along with the</span>
<span class="sd">            segmentlist. Default=None, in this case segment_summary is taken</span>
<span class="sd">            from the valid_segment of the SegFile class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seglistdict</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>
        <span class="n">seglistdict</span><span class="p">[</span><span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">segmentlist</span>
        <span class="n">seg_summ_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">seg_summ_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seg_summ_dict</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>
            <span class="n">seg_summ_dict</span><span class="p">[</span><span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_summ_list</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_segment_list_dict</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">seglistdict</span><span class="p">,</span>
                                          <span class="n">seg_summ_dict</span><span class="o">=</span><span class="n">seg_summ_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="SegFile.from_multi_segment_list">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.SegFile.from_multi_segment_list">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_multi_segment_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">segmentlists</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">ifos</span><span class="p">,</span>
                                <span class="n">seg_summ_lists</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize a SegFile object from a list of segmentlists.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        description : string (required)</span>
<span class="sd">            See File.__init__</span>
<span class="sd">        segmentlists : List of igwn_segments.segmentslist</span>
<span class="sd">            List of segment lists that will be stored in this file.</span>
<span class="sd">        names : List of str</span>
<span class="sd">            List of names of the segment lists to be stored in the file.</span>
<span class="sd">        ifos : str</span>
<span class="sd">            List of ifos of the segment lists to be stored in this file.</span>
<span class="sd">        seg_summ_lists : igwn_segments.segmentslist (OPTIONAL)</span>
<span class="sd">            Specify the segment_summary segmentlists that go along with the</span>
<span class="sd">            segmentlists. Default=None, in this case segment_summary is taken</span>
<span class="sd">            from the valid_segment of the SegFile class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seglistdict</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span> <span class="n">segmentlist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">ifos</span><span class="p">,</span> <span class="n">segmentlists</span><span class="p">):</span>
            <span class="n">seglistdict</span><span class="p">[</span><span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">segmentlist</span>
        <span class="k">if</span> <span class="n">seg_summ_lists</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seg_summ_dict</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ifo</span><span class="p">,</span> <span class="n">seg_summ_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">ifos</span><span class="p">,</span> <span class="n">seg_summ_lists</span><span class="p">):</span>
                <span class="n">seg_summ_dict</span><span class="p">[</span><span class="n">ifo</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_summ_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seg_summ_dict</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_segment_list_dict</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">seglistdict</span><span class="p">,</span>
                                         <span class="n">seg_summ_dict</span><span class="o">=</span><span class="n">seg_summ_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="SegFile.from_segment_list_dict">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.SegFile.from_segment_list_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_segment_list_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">segmentlistdict</span><span class="p">,</span>
                               <span class="n">ifo_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valid_segment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">file_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seg_summ_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize a SegFile object from a segmentlistdict.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        description : string (required)</span>
<span class="sd">            See File.__init__</span>
<span class="sd">        segmentlistdict : igwn_segments.segmentslistdict</span>
<span class="sd">            See SegFile.__init__</span>
<span class="sd">        ifo_list : string or list (optional)</span>
<span class="sd">            See File.__init__, if not given a list of all ifos in the</span>
<span class="sd">            segmentlistdict object will be used</span>
<span class="sd">        valid_segment : igwn_segments.segment or igwn_segments.segmentlist</span>
<span class="sd">            See File.__init__, if not given the extent of all segments in the</span>
<span class="sd">            segmentlistdict is used.</span>
<span class="sd">        file_exists : boolean (default = False)</span>
<span class="sd">            If provided and set to True it is assumed that this file already</span>
<span class="sd">            exists on disk and so there is no need to write again.</span>
<span class="sd">        seg_summ_dict : igwn_segments.segmentslistdict</span>
<span class="sd">            Optional. See SegFile.__init__.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ifo_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ifo_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">segmentlistdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="n">ifo_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ifo_set</span><span class="p">)</span>
            <span class="n">ifo_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">valid_segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seg_summ_dict</span> <span class="ow">and</span> \
                    <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">seg_summ_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]):</span>
                <span class="c1"># Only come here if seg_summ_dict is supplied and it is</span>
                <span class="c1"># not empty.</span>
                <span class="n">valid_segment</span> <span class="o">=</span> <span class="n">seg_summ_dict</span><span class="o">.</span><span class="n">extent_all</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">valid_segment</span> <span class="o">=</span> <span class="n">segmentlistdict</span><span class="o">.</span><span class="n">extent_all</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># Numpty probably didn&#39;t supply a</span>
                    <span class="c1"># igwn_segments.segmentlistdict</span>
                    <span class="n">segmentlistdict</span><span class="o">=</span><span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">(</span><span class="n">segmentlistdict</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">valid_segment</span> <span class="o">=</span> <span class="n">segmentlistdict</span><span class="o">.</span><span class="n">extent_all</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># No segment_summary and segment list is empty</span>
                        <span class="c1"># Setting valid segment now is hard!</span>
                        <span class="n">warn_msg</span> <span class="o">=</span> <span class="s2">&quot;No information with which to set valid &quot;</span>
                        <span class="n">warn_msg</span> <span class="o">+=</span> <span class="s2">&quot;segment.&quot;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>
                        <span class="n">valid_segment</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">instnc</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">ifo_list</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">valid_segment</span><span class="p">,</span>
                     <span class="n">segment_dict</span><span class="o">=</span><span class="n">segmentlistdict</span><span class="p">,</span> <span class="n">seg_summ_dict</span><span class="o">=</span><span class="n">seg_summ_dict</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">:</span>
            <span class="n">instnc</span><span class="o">.</span><span class="n">to_segment_xml</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">instnc</span><span class="o">.</span><span class="n">add_pfn</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="s1">&#39;file:&#39;</span><span class="p">,</span> <span class="n">pathname2url</span><span class="p">(</span><span class="n">instnc</span><span class="o">.</span><span class="n">storage_path</span><span class="p">)),</span>
                           <span class="n">site</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instnc</span></div>


<div class="viewcode-block" id="SegFile.from_segment_xml">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.SegFile.from_segment_xml">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_segment_xml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">xml_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a igwn_segments.segmentlist from the file object file containing an</span>
<span class="sd">        xml segment table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        xml_file : file object</span>
<span class="sd">            file object for segment xml file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load xmldocument and SegmentDefTable and SegmentTables</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">xml_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">xmldoc</span> <span class="o">=</span> <span class="n">ligolw_utils</span><span class="o">.</span><span class="n">load_fileobj</span><span class="p">(</span>
                <span class="n">fp</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">contenthandler</span><span class="o">=</span><span class="n">LIGOLWContentHandler</span><span class="p">)</span>

        <span class="n">seg_def_table</span> <span class="o">=</span> <span class="n">lsctables</span><span class="o">.</span><span class="n">SegmentDefTable</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">xmldoc</span><span class="p">)</span>
        <span class="n">seg_table</span> <span class="o">=</span> <span class="n">lsctables</span><span class="o">.</span><span class="n">SegmentTable</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">xmldoc</span><span class="p">)</span>
        <span class="n">seg_sum_table</span> <span class="o">=</span> <span class="n">lsctables</span><span class="o">.</span><span class="n">SegmentSumTable</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">xmldoc</span><span class="p">)</span>

        <span class="n">segs</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>
        <span class="n">seg_summ</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlistdict</span><span class="p">()</span>

        <span class="n">seg_id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">seg_def</span> <span class="ow">in</span> <span class="n">seg_def_table</span><span class="p">:</span>
            <span class="c1"># Here we want to encode ifo and segment name</span>
            <span class="n">full_channel_name</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">seg_def</span><span class="o">.</span><span class="n">ifos</span><span class="p">),</span>
                                          <span class="nb">str</span><span class="p">(</span><span class="n">seg_def</span><span class="o">.</span><span class="n">name</span><span class="p">)])</span>
            <span class="n">seg_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">seg_def</span><span class="o">.</span><span class="n">segment_def_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">full_channel_name</span>
            <span class="n">segs</span><span class="p">[</span><span class="n">full_channel_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">()</span>
            <span class="n">seg_summ</span><span class="p">[</span><span class="n">full_channel_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">seg_table</span><span class="p">:</span>
            <span class="n">seg_obj</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span>
                    <span class="n">lal</span><span class="o">.</span><span class="n">LIGOTimeGPS</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">start_time_ns</span><span class="p">),</span>
                    <span class="n">lal</span><span class="o">.</span><span class="n">LIGOTimeGPS</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">end_time_ns</span><span class="p">))</span>
            <span class="n">segs</span><span class="p">[</span><span class="n">seg_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">segment_def_id</span><span class="p">)]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg_obj</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">seg_sum_table</span><span class="p">:</span>
            <span class="n">seg_obj</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span>
                    <span class="n">lal</span><span class="o">.</span><span class="n">LIGOTimeGPS</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">start_time_ns</span><span class="p">),</span>
                    <span class="n">lal</span><span class="o">.</span><span class="n">LIGOTimeGPS</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">end_time_ns</span><span class="p">))</span>
            <span class="n">seg_summ</span><span class="p">[</span><span class="n">seg_id</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">segment_def_id</span><span class="p">)]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg_obj</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">seg_name</span> <span class="ow">in</span> <span class="n">seg_id</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">segs</span><span class="p">[</span><span class="n">seg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">segs</span><span class="p">[</span><span class="n">seg_name</span><span class="p">]</span><span class="o">.</span><span class="n">coalesce</span><span class="p">()</span>

        <span class="n">xmldoc</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">curr_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlunparse</span><span class="p">([</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">xml_file</span><span class="p">,</span>
                                            <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_segment_list_dict</span><span class="p">(</span><span class="s1">&#39;SEGMENTS&#39;</span><span class="p">,</span> <span class="n">segs</span><span class="p">,</span> <span class="n">file_url</span><span class="o">=</span><span class="n">curr_url</span><span class="p">,</span>
                                          <span class="n">file_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">seg_summ_dict</span><span class="o">=</span><span class="n">seg_summ</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="SegFile.remove_short_sci_segs">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.SegFile.remove_short_sci_segs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_short_sci_segs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minSegLength</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to remove all science segments</span>
<span class="sd">        shorter than a specific length. Also updates the file on disk to remove</span>
<span class="sd">        these segments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        minSegLength : int</span>
<span class="sd">            Maximum length of science segments. Segments shorter than this will</span>
<span class="sd">            be removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newsegment_list</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">seglist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">newsegment_list</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segmentlist</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">seglist</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">minSegLength</span><span class="p">:</span>
                    <span class="n">newsegment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>
            <span class="n">newsegment_list</span><span class="o">.</span><span class="n">coalesce</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">segment_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">newsegment_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_segment_xml</span><span class="p">(</span><span class="n">override_file_if_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="SegFile.return_union_seglist">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.SegFile.return_union_seglist">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_union_seglist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_dict</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<div class="viewcode-block" id="SegFile.parse_segdict_key">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.SegFile.parse_segdict_key">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_segdict_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return ifo and name from the segdict key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">splt</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">splt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">splt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Key should be of the format &#39;ifo:name&#39;, got </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="SegFile.to_segment_xml">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.SegFile.to_segment_xml">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_segment_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">override_file_if_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the segment list in self.segmentList to self.storage_path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create XML doc and add process table</span>
        <span class="n">outdoc</span> <span class="o">=</span> <span class="n">ligolw</span><span class="o">.</span><span class="n">Document</span><span class="p">()</span>
        <span class="n">outdoc</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">ligolw</span><span class="o">.</span><span class="n">LIGO_LW</span><span class="p">())</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">create_process_table</span><span class="p">(</span><span class="n">outdoc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">seglist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ifo</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_segdict_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="c1"># Ensure we have LIGOTimeGPS</span>
            <span class="n">fsegs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lal</span><span class="o">.</span><span class="n">LIGOTimeGPS</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                      <span class="n">lal</span><span class="o">.</span><span class="n">LIGOTimeGPS</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">seglist</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg_summ_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vsegs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lal</span><span class="o">.</span><span class="n">LIGOTimeGPS</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                          <span class="n">lal</span><span class="o">.</span><span class="n">LIGOTimeGPS</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> \
                         <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_segments</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vsegs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lal</span><span class="o">.</span><span class="n">LIGOTimeGPS</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                          <span class="n">lal</span><span class="o">.</span><span class="n">LIGOTimeGPS</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> \
                         <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg_summ_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>

            <span class="c1"># Add using glue library to set all segment tables</span>
            <span class="k">with</span> <span class="n">ligolw_segments</span><span class="o">.</span><span class="n">LigolwSegments</span><span class="p">(</span><span class="n">outdoc</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ligolw_segments</span><span class="o">.</span><span class="n">LigolwSegmentList</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">fsegs</span><span class="p">,</span>
                                    <span class="n">instruments</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="n">ifo</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="n">vsegs</span><span class="p">))</span>

        <span class="c1"># write file</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="s1">&#39;file:&#39;</span><span class="p">,</span> <span class="n">pathname2url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">override_file_if_exists</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_pfn</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_pfn</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
        <span class="n">ligolw_utils</span><span class="o">.</span><span class="n">write_filename</span><span class="p">(</span><span class="n">outdoc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="make_external_call">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.make_external_call">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_external_call</span><span class="p">(</span><span class="n">cmdList</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_basename</span><span class="o">=</span><span class="s1">&#39;external_call&#39;</span><span class="p">,</span>
                       <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use this to make an external call using the python subprocess module.</span>
<span class="sd">    See the subprocess documentation for more details of how this works.</span>
<span class="sd">    http://docs.python.org/2/library/subprocess.html</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    cmdList : list of strings</span>
<span class="sd">        This list of strings contains the command to be run. See the subprocess</span>
<span class="sd">        documentation for more details.</span>
<span class="sd">    out_dir : string</span>
<span class="sd">        If given the stdout and stderr will be redirected to</span>
<span class="sd">        os.path.join(out_dir,out_basename+[&quot;.err&quot;,&quot;.out])</span>
<span class="sd">        If not given the stdout and stderr will not be recorded</span>
<span class="sd">    out_basename : string</span>
<span class="sd">        The value of out_basename used to construct the file names used to</span>
<span class="sd">        store stderr and stdout. See out_dir for more information.</span>
<span class="sd">    shell : boolean, default=False</span>
<span class="sd">        This value will be given as the shell kwarg to the subprocess call.</span>
<span class="sd">        **WARNING** See the subprocess documentation for details on this</span>
<span class="sd">        Kwarg including a warning about a serious security exploit. Do not</span>
<span class="sd">        use this unless you are sure it is necessary **and** safe.</span>
<span class="sd">    fail_on_error : boolean, default=True</span>
<span class="sd">        If set to true an exception will be raised if the external command does</span>
<span class="sd">        not return a code of 0. If set to false such failures will be ignored.</span>
<span class="sd">        Stderr and Stdout can be stored in either case using the out_dir</span>
<span class="sd">        and out_basename options.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    exitCode : int</span>
<span class="sd">        The code returned by the process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">out_dir</span><span class="p">:</span>
        <span class="n">outBase</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="n">out_basename</span><span class="p">)</span>
        <span class="n">errFile</span> <span class="o">=</span> <span class="n">outBase</span> <span class="o">+</span> <span class="s1">&#39;.err&#39;</span>
        <span class="n">errFP</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">errFile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">outFile</span> <span class="o">=</span> <span class="n">outBase</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span>
        <span class="n">outFP</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outFile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">cmdFile</span> <span class="o">=</span> <span class="n">outBase</span> <span class="o">+</span> <span class="s1">&#39;.sh&#39;</span>
        <span class="n">cmdFP</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cmdFile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">cmdFP</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdList</span><span class="p">))</span>
        <span class="n">cmdFP</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">errFile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">outFile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cmdFile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">errFP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">outFP</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Making external call </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdList</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">errCode</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdList</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">errFP</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">outFP</span><span class="p">,</span>\
                              <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">errFP</span><span class="p">:</span>
        <span class="n">errFP</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">outFP</span><span class="p">:</span>
        <span class="n">outFP</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">errCode</span> <span class="ow">and</span> <span class="n">fail_on_error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CalledProcessErrorMod</span><span class="p">(</span><span class="n">errCode</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdList</span><span class="p">),</span>
                <span class="n">errFile</span><span class="o">=</span><span class="n">errFile</span><span class="p">,</span> <span class="n">outFile</span><span class="o">=</span><span class="n">outFile</span><span class="p">,</span> <span class="n">cmdFile</span><span class="o">=</span><span class="n">cmdFile</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Call successful, or error checking disabled.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="CalledProcessErrorMod">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.CalledProcessErrorMod">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CalledProcessErrorMod</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This exception is raised when subprocess.call returns a non-zero exit code</span>
<span class="sd">    and checking has been requested. This should not be accessed by the user</span>
<span class="sd">    it is used only within make_external_call.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">errFile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outFile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cmdFile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errFile</span> <span class="o">=</span> <span class="n">errFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outFile</span> <span class="o">=</span> <span class="n">outFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdFile</span> <span class="o">=</span> <span class="n">cmdFile</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Command &#39;</span><span class="si">%s</span><span class="s2">&#39; returned non-zero exit status </span><span class="si">%d</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span> \
              <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errFile</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Stderr can be found in </span><span class="si">%s</span><span class="s2"> .</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errFile</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outFile</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Stdout can be found in </span><span class="si">%s</span><span class="s2"> .</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outFile</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdFile</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;The failed command has been printed in </span><span class="si">%s</span><span class="s2"> .&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmdFile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span></div>



<div class="viewcode-block" id="resolve_url_to_file">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.resolve_url_to_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">resolve_url_to_file</span><span class="p">(</span>
    <span class="n">curr_pfn</span><span class="p">,</span>
    <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hash_max_chunks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">hash_chunk_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolves a PFN into a workflow.File object.</span>

<span class="sd">    This function will resolve a PFN to a workflow.File object. If a File</span>
<span class="sd">    object already exists for that PFN that will be returned, otherwise a new</span>
<span class="sd">    object is returned. We will implement default site schemes here as needed,</span>
<span class="sd">    for example cvfms paths will be added to the osg and nonfsio sites in</span>
<span class="sd">    addition to local. If the LFN is a duplicate of an existing one, but with a</span>
<span class="sd">    different PFN an AssertionError is raised. The attrs keyword-argument can</span>
<span class="sd">    be used to specify attributes of a file. All files have 4 possible</span>
<span class="sd">    attributes. A list of ifos, an identifying string - usually used to give</span>
<span class="sd">    the name of the executable that created the file, a segmentlist over which</span>
<span class="sd">    the file is valid and tags specifying particular details about those files.</span>
<span class="sd">    If attrs[&#39;ifos&#39;] is set it will be used as the ifos, otherwise this will</span>
<span class="sd">    default to [&#39;H1&#39;, &#39;K1&#39;, &#39;L1&#39;, &#39;V1&#39;]. If attrs[&#39;exe_name&#39;] is given this</span>
<span class="sd">    will replace the &quot;exe_name&quot; sent to File.__init__ otherwise &#39;INPUT&#39; will</span>
<span class="sd">    be given. segs will default to [[1,2000000000]] unless overridden with</span>
<span class="sd">    attrs[&#39;segs&#39;]. tags will default to an empty list unless overriden</span>
<span class="sd">    with attrs[&#39;tag&#39;]. If attrs is None it will be ignored and all defaults</span>
<span class="sd">    will be used. It is emphasized that these attributes are for the most part</span>
<span class="sd">    not important with input files. Exceptions include things like input</span>
<span class="sd">    template banks, where ifos and valid times will be checked in the workflow</span>
<span class="sd">    and used in the naming of child job output files.</span>

<span class="sd">    hash_max_chunks and hash_chunk_size are used to decide how much of the</span>
<span class="sd">    files to check before they are considered the same, and not copied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cvmfsstr1</span> <span class="o">=</span> <span class="s1">&#39;file:///cvmfs/&#39;</span>
    <span class="n">cvmfsstr2</span> <span class="o">=</span> <span class="s1">&#39;file://localhost/cvmfs/&#39;</span>
    <span class="n">osdfstr1</span> <span class="o">=</span> <span class="s1">&#39;osdf:///&#39;</span>  <span class="c1"># Technically this isn&#39;t CVMFS, but same handling!</span>
    <span class="n">cvmfsstrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">cvmfsstr1</span><span class="p">,</span> <span class="n">cvmfsstr2</span><span class="p">,</span> <span class="n">osdfstr1</span><span class="p">)</span>

    <span class="c1"># Get LFN</span>
    <span class="n">urlp</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">curr_pfn</span><span class="p">)</span>
    <span class="n">curr_lfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">urlp</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Does this already exist as a File?</span>
    <span class="k">if</span> <span class="n">curr_lfn</span> <span class="ow">in</span> <span class="n">file_input_from_config_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">file_pfn</span> <span class="o">=</span> <span class="n">file_input_from_config_dict</span><span class="p">[</span><span class="n">curr_lfn</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># If the PFNs are different, but LFNs are the same then fail.</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">file_pfn</span> <span class="o">==</span> <span class="n">curr_pfn</span><span class="p">)</span>
        <span class="n">curr_file</span> <span class="o">=</span> <span class="n">file_input_from_config_dict</span><span class="p">[</span><span class="n">curr_lfn</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use resolve_url to download file/symlink as appropriate</span>
        <span class="n">local_file_path</span> <span class="o">=</span> <span class="n">resolve_url</span><span class="p">(</span>
            <span class="n">curr_pfn</span><span class="p">,</span>
            <span class="n">hash_max_chunks</span><span class="o">=</span><span class="n">hash_max_chunks</span><span class="p">,</span>
            <span class="n">hash_chunk_size</span><span class="o">=</span><span class="n">hash_chunk_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Create File object with default local path</span>
        <span class="n">curr_file</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">curr_pfn</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">cvmfsstrs</span><span class="p">):</span>
            <span class="c1"># Add PFNs for nonlocal sites for special cases (e.g. CVMFS).</span>
            <span class="c1"># This block could be extended as needed</span>
            <span class="n">curr_file</span><span class="o">.</span><span class="n">add_pfn</span><span class="p">(</span><span class="n">curr_pfn</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pfn_local</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="s1">&#39;file:&#39;</span><span class="p">,</span> <span class="n">pathname2url</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">))</span>
            <span class="n">curr_file</span><span class="o">.</span><span class="n">add_pfn</span><span class="p">(</span><span class="n">pfn_local</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span>
        <span class="c1"># Store the file to avoid later duplication</span>
        <span class="n">tuple_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">curr_file</span><span class="p">,</span> <span class="n">curr_pfn</span><span class="p">)</span>
        <span class="n">file_input_from_config_dict</span><span class="p">[</span><span class="n">curr_lfn</span><span class="p">]</span> <span class="o">=</span> <span class="n">tuple_val</span>
    <span class="k">return</span> <span class="n">curr_file</span></div>



<div class="viewcode-block" id="configparser_value_to_file">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.configparser_value_to_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">configparser_value_to_file</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch a file given its url location via the section</span>
<span class="sd">    and option in the workflow configuration parser.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    cp : ConfigParser object</span>
<span class="sd">         The ConfigParser object holding the workflow configuration settings</span>
<span class="sd">    sec : string</span>
<span class="sd">         The section containing options for this job.</span>
<span class="sd">    opt : string</span>
<span class="sd">         Name of option (e.g. --output-file)</span>
<span class="sd">    attrs : list to specify the 4 attributes of the file.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    fileobj_from_path : workflow.File object obtained from the path</span>
<span class="sd">        specified by opt, within sec, in cp.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
    <span class="n">fileobj_from_path</span> <span class="o">=</span> <span class="n">resolve_url_to_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fileobj_from_path</span></div>



<div class="viewcode-block" id="get_full_analysis_chunk">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.get_full_analysis_chunk">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_full_analysis_chunk</span><span class="p">(</span><span class="n">science_segs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to find the first and last time point contained in the science segments</span>
<span class="sd">    and return a single segment spanning that full time.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    science_segs : ifo-keyed dictionary of igwn_segments.segmentlist instances</span>
<span class="sd">        The list of times that are being analysed in this workflow.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    fullSegment : igwn_segments.segment</span>
<span class="sd">        The segment spanning the first and last time point contained in science_segs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">extents</span> <span class="o">=</span> <span class="p">[</span><span class="n">science_segs</span><span class="p">[</span><span class="n">ifo</span><span class="p">]</span><span class="o">.</span><span class="n">extent</span><span class="p">()</span> <span class="k">for</span> <span class="n">ifo</span> <span class="ow">in</span> <span class="n">science_segs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span> <span class="o">=</span> <span class="n">extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="ow">in</span> <span class="n">extents</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">min</span> <span class="o">&gt;</span> <span class="n">lo</span><span class="p">:</span>
            <span class="nb">min</span> <span class="o">=</span> <span class="n">lo</span>
        <span class="k">if</span> <span class="nb">max</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="p">:</span>
            <span class="nb">max</span> <span class="o">=</span> <span class="n">hi</span>
    <span class="n">fullSegment</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fullSegment</span></div>



<div class="viewcode-block" id="get_random_label">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.get_random_label">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_random_label</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a random label string to use when clustering jobs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> \
                   <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span></div>



<div class="viewcode-block" id="resolve_td_option">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.resolve_td_option">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">resolve_td_option</span><span class="p">(</span><span class="n">val_str</span><span class="p">,</span> <span class="n">valid_seg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take an option which might be time-dependent and resolve it</span>

<span class="sd">    Some options might take different values depending on the GPS time. For</span>
<span class="sd">    example if you want opt_1 to take value_a if the time is between 10 and</span>
<span class="sd">    100, value_b if between 100 and 250, and value_c if between 250 and 500 you</span>
<span class="sd">    can supply:</span>

<span class="sd">    value_a[10:100],value_b[100:250],value_c[250:500].</span>

<span class="sd">    This function will parse that string (as opt) and return the value fully</span>
<span class="sd">    contained in valid_seg. If valid_seg is not full contained in one, and only</span>
<span class="sd">    one, of these options. The code will fail. If given a simple option like:</span>

<span class="sd">    value_a</span>

<span class="sd">    The function will just return value_a.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Track if we&#39;ve already found a matching option</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Strip any whitespace, and split on comma</span>
    <span class="n">curr_vals</span> <span class="o">=</span> <span class="n">val_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="c1"># Resolving the simple case is trivial and can be done immediately.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;[&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">curr_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">curr_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Loop over all possible values</span>
    <span class="k">for</span> <span class="n">cval</span> <span class="ow">in</span> <span class="n">curr_vals</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_seg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_seg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Extract limits for each case, and check overlap with valid_seg</span>
        <span class="k">if</span> <span class="s1">&#39;[&#39;</span> <span class="ow">in</span> <span class="n">cval</span><span class="p">:</span>
            <span class="n">bopt</span> <span class="o">=</span> <span class="n">cval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">bopt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">cval</span> <span class="o">=</span> <span class="n">cval</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">bopt</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">curr_seg</span> <span class="o">=</span> <span class="n">segments</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
        <span class="c1"># The segments module is a bit weird so we need to check if the two</span>
        <span class="c1"># overlap using the following code. If valid_seg is fully within</span>
        <span class="c1"># curr_seg this will be true.</span>
        <span class="k">if</span> <span class="n">curr_seg</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">valid_seg</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">curr_seg</span> <span class="o">&amp;</span> <span class="n">valid_seg</span> <span class="o">==</span> <span class="n">valid_seg</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Time-dependent options must be disjoint.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">cval</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Could not resolve option </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val_str</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">return</span> <span class="n">output</span></div>



<div class="viewcode-block" id="add_workflow_settings_cli">
<a class="viewcode-back" href="../../../pycbc.workflow.html#pycbc.workflow.core.add_workflow_settings_cli">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_workflow_settings_cli</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">include_subdax_opts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds workflow options to an argument parser.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parser : argparse.ArgumentParser</span>
<span class="sd">        Argument parser to add the options to.</span>
<span class="sd">    include_subdax_opts : bool, optional</span>
<span class="sd">        If True, will add output-map and dax-file-directory options</span>
<span class="sd">        to the parser. These can be used for workflows that are</span>
<span class="sd">        generated as a subdax of another workflow. Default is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wfgrp</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;Options for setting workflow files&quot;</span><span class="p">)</span>
    <span class="n">wfgrp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--workflow-name&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the workflow.&quot;</span><span class="p">)</span>
    <span class="n">wfgrp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--tags&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Append the given tags to file names.&quot;</span><span class="p">)</span>
    <span class="n">wfgrp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--output-dir&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to directory where the workflow will be &quot;</span>
                            <span class="s2">&quot;written. Default is to use &quot;</span>
                            <span class="s2">&quot;{workflow-name}_output.&quot;</span><span class="p">)</span>
    <span class="n">wfgrp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--cache-file&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to input file containing list of files to &quot;</span>
                            <span class="s2">&quot;be reused (the &#39;input_map&#39; file)&quot;</span><span class="p">)</span>
    <span class="n">wfgrp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--submit-now&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If given, workflow will immediately be submitted &quot;</span>
                            <span class="s2">&quot;on completion of workflow generation&quot;</span><span class="p">)</span>
    <span class="n">wfgrp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dax-file&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to DAX file. Default is to write to the &quot;</span>
                            <span class="s2">&quot;output directory with name &quot;</span>
                            <span class="s2">&quot;{workflow-name}.dax.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">include_subdax_opts</span><span class="p">:</span>
        <span class="n">wfgrp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--output-map&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to an output map file.&quot;</span><span class="p">)</span>
        <span class="n">wfgrp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dax-file-directory&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Put dax files (including output map, &quot;</span>
                                <span class="s2">&quot;sites.yml etc. in this directory. The use &quot;</span>
                                <span class="s2">&quot;case for this is when running a sub-workflow &quot;</span>
                                <span class="s2">&quot;under pegasus the outputs need to be copied &quot;</span>
                                <span class="s2">&quot;back to the appropriate directory, and &quot;</span>
                                <span class="s2">&quot;using this as --dax-file-directory . allows &quot;</span>
                                <span class="s2">&quot;that to be done.&quot;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015, 2016, 2017, Alexander Nitz, Ian Harry, Christopher M. Biwer, Duncan A.  Brown, Josh Willis, and Tito Dal Canton.
      <span class="lastupdated">Last updated on Feb 06, 2026.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>