name: docker build

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      -
        uses: actions/checkout@v1
      -
      - name: Set release version environment variable
        if: startsWith(github.ref, 'refs/tags')
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
      - name: Update version file for release
        if: startsWith(github.ref, 'refs/tags')
        uses: ./.github/actions/update-version
        with:
          version: ${{ env.RELEASE_VERSION }}
          release: 'true'
        name: "Preparing a host container"
        run: "docker build -t pycbc-docker-tmp ."
      -
        name: "Installing PyCBC and dependencies"
        run: "docker run --privileged --name pycbc_inst -v `pwd`:/scratch pycbc-docker-tmp /bin/bash -c /scratch/docker/etc/docker-install.sh"
      -
        env:
          DOCKER_IMG: pycbc/pycbc-el8
        name: "Running docker commit"
        run: "bash -e docker/etc/docker_commit.sh"
      -
        env:
          DOCKER_IMG: pycbc/pycbc-el8
          DOCKER_PASSWORD: "${{secrets.DOCKERHUB_PASSWORD}}"
          DOCKER_USERNAME: "${{secrets.DOCKERHUB_USERNAME}}"
        name: "Pushing docker image"
        run: "bash -e docker/etc/push_image.sh"
