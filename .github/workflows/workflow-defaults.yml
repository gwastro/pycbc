---
# Provide default values used across workflows.
# Add new defaults (inputs) here and expose them as outputs so other
# workflows can consume them via `needs.<job>.outputs.<name>`.
on:
  workflow_call:
    inputs:
      python-version:
        description: 'Default Python version for workflows'
        required: false
        type: string
        default: '3.11'
    outputs:
      python_version:
        description: 'Python version string to use in workflows'
        value: ${{ jobs.provide.outputs.python_version }}
      lal_data_path:
        description: 'Path where LAL auxiliary data is cached on the runner'
        value: ${{ jobs.provide.outputs.lal_data_path }}
      example_gw_cache_key:
        description: 'Cache key used for example GW data (useful when restoring cache)'
        value: ${{ jobs.provide.outputs.example_gw_cache_key }}


jobs:
  provide:
    runs-on: ubuntu-latest
    outputs:
      python_version: ${{ steps.set.outputs.python_version }}
      lal_data_path: ${{ steps.set_paths.outputs.lal_data_path }}
      example_gw_cache_key: ${{ steps.set_paths.outputs.example_gw_cache_key }}

    steps:
      - id: set
        run: |
          # Export inputs as outputs via GITHUB_OUTPUT so other jobs can use them
          echo "python_version=${{ inputs.python-version }}" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache LAL auxiliary data files
        id: cache-lal-aux-data
        uses: actions/cache@v4
        with:
          key: lal-aux-data
          path: $HOME/lal_aux_data

      - if: ${{ steps.cache-lal-aux-data.outputs.cache-hit != 'true' }}
        name: Download LAL auxiliary data files
        run: |
          mkdir -p $HOME/lal_aux_data
          pushd $HOME/lal_aux_data
          # Retry transient network errors up to 3 times with a short delay
          curl --show-error --silent --fail --retry 3 --retry-delay 5 --retry-connrefused \
            --remote-name https://zenodo.org/records/14999310/files/SEOBNRv4ROM_v2.0.hdf5 \
            --remote-name https://zenodo.org/records/14999310/files/SEOBNRv4ROM_v3.0.hdf5
          popd

      - name: Cache example GW data
        id: cache-example-gw-data
        uses: actions/cache@v4
        with:
          key: example-gw-data
          path: |
            docs/_include/*_TDI_v2.gwf
            docs/_include/*_GWOSC_4KHZ_R1-1126257415-4096.gwf
            docs/_include/*_LOSC_CLN_4_V1-1187007040-2048.gwf
            examples/inference/lisa_smbhb_ldc/*_psd.txt
            examples/inference/lisa_smbhb_ldc/*_TDI_v2.gwf
            examples/inference/lisa_smbhb_ldc/MBHB_params_v2_LISA_frame.pkl
            examples/inference/margtime/*.gwf
            examples/inference/multisignal/*.gwf
            examples/inference/relative/*.gwf
            examples/inference/relmarg/*.gwf
            examples/inference/single/*.gwf
            examples/search/*.gwf

      - id: set_paths
        name: Set path outputs for cached data
        run: |
          # Expose the LAL data path and cache key so callers can reference them
          echo "lal_data_path=$HOME/lal_aux_data" >> $GITHUB_OUTPUT
          echo "example_gw_cache_key=example-gw-data" >> $GITHUB_OUTPUT

