name: Code quality checks
on: [pull_request]
jobs:

  linters:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install linters
        run: pip install flake8 pylint

      - name: Check executables for unused imports
        run: flake8 --select=F401 $(find bin -type f -name pycbc_*)
      - name: Check executables for unused variables (report only)
        run: flake8 --select=F841 $(find bin -type f -name pycbc_*) || true
      - name: Check modules for unused imports
        run: |
          flake8 --select=F401 $(find pycbc | grep '\.py$' | grep -v -e __init__ -e 'version.py')
      - name: Check modules for unused variables (report only)
        run: |
          flake8 --select=F841 $(find pycbc | grep '\.py$' | grep -v -e __init__ -e 'version.py') || true
      - name: Check tests for unused imports
        run: |
          flake8 --select=F401 $(find test | grep '\.py$' | grep -v test_schemes)
      - name: Check tests for unused variables (report only)
        run: |
          flake8 --select=F841 $(find test | grep '\.py$' | grep -v test_schemes) || true
      - name: Run pylint
        run: |
          PYLINT_OUTPUT=$(python -m pylint --disable=all --enable=unreachable,unused-argument pycbc 2>&1 || true)
      - name: Check for any unused function arguments (report only)
        run: |
          echo $PYLINT_OUTPUT | grep unused-argument
      - name: Fail on any unreachable pylint output
        if: $PYLINT_OUTPUT | grep unreachable
        run:
          echo $PYLINT_OUTPUT | grep unreachable
          exit 1



